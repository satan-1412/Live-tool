<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OSB PLAYER | PRO</title>
    
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* ================== V6.0 è§†è§‰ç³»ç»Ÿ ================== */
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #fff;
            --accent: #00ff88; /* æå®¢ç»¿ */
            --video-h: 35vh; /* ç«–å±æ—¶è§†é¢‘é«˜åº¦ */
        }
        
        body.root-mode {
            --bg: #1a0510;
            --card: #2d0a1a;
            --accent: #ff0055; /* éœ“è™¹ç²‰ */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; overflow: hidden; transition: 0.5s; }

        /* ================== 1. å¤§å…è§†å›¾ (Lobby) ================== */
        #view-lobby {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            padding: 12px 15px; background: rgba(30,30,30,0.95);
            display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 50;
        }
        .logo { 
            font-size: 22px; font-weight: 900; color: var(--accent); letter-spacing: -1px; 
            padding: 5px; cursor: pointer; user-select: none;
        }
        .search-wrap { flex: 1; position: relative; }
        .search-inp {
            width: 100%; background: #333; border: none; border-radius: 4px;
            padding: 8px 10px 8px 30px; color: #fff; font-size: 14px;
        }
        .search-icon { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: #777; }

        /* åˆ†ç±»ä¸å®«æ ¼ */
        #nav-tags {
            padding: 10px 15px; display: flex; gap: 10px; overflow-x: auto;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .tag {
            padding: 5px 12px; border-radius: 15px; background: rgba(255,255,255,0.1); 
            color: #aaa; font-size: 13px; white-space: nowrap;
        }
        .tag.active { background: var(--accent); color: #000; font-weight: bold; }

        #grid {
            flex: 1; overflow-y: auto; padding: 15px;
            display: grid; grid-template-columns: repeat(2, 1fr); /* æ‰‹æœºåŒåˆ— */
            gap: 15px; align-content: start;
        }
        @media(min-width: 768px) { #grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }

        .card {
            background: var(--card); border-radius: 8px; overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); position: relative;
        }
        .card-img-box { width: 100%; aspect-ratio: 16/9; background: #000; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-fallback {
            position: absolute; top:0; left:0; width:100%; height:100%;
            display: flex; align-items: center; justify-content: center;
            color: #333; font-size: 30px;
        }
        .card-name {
            padding: 10px; font-size: 13px; text-align: center; color: #ddd;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* ================== 2. æ’­æ”¾å®¤è§†å›¾ (Room) ================== */
        #view-room {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
        }
        #view-room.active { transform: translateX(0); }

        /* è§†é¢‘å®¹å™¨ (ä¸Šéƒ¨) */
        #video-wrap {
            width: 100%; height: var(--video-h); background: #000; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        /* å…¨å±æ—¶ */
        #video-wrap.fullscreen { height: 100%; position: absolute; z-index: 999; }

        video { width: 100%; height: 100%; }
        iframe { width: 100%; height: 100%; border: none; }

        #danmaku-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        /* è§†é¢‘è¦†ç›–å±‚ (è¿”å›æŒ‰é’®) */
        .vid-overlay {
            position: absolute; top: 0; left: 0; width: 100%; padding: 10px;
            display: flex; justify-content: space-between; z-index: 20;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
        }
        .btn-back { 
            pointer-events: auto; color: #fff; font-size: 20px; 
            padding: 5px 10px; background: rgba(0,0,0,0.3); border-radius: 50%;
        }

        /* äº’åŠ¨æ§åˆ¶åŒº (ä¸‹éƒ¨) */
        #room-controls {
            flex: 1; background: var(--bg); display: flex; flex-direction: column;
            border-top: 1px solid #333;
        }
        
        /* ä¿¡æ¯æ¡ */
        .info-bar {
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: space-between;
        }
        .ch-title { font-size: 16px; font-weight: bold; }
        .live-badge {
            background: #cc0000; color: #fff; font-size: 12px; padding: 2px 6px; 
            border-radius: 4px; display: none; align-items: center; gap: 4px;
        }
        .live-dot { width: 6px; height: 6px; background: #fff; border-radius: 50%; animation: blink 1s infinite; }

        /* å¼¹å¹•è¾“å…¥åŒº */
        .chat-bar {
            padding: 10px 15px; background: var(--card);
            display: flex; gap: 10px; align-items: center;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .chat-inp {
            flex: 1; background: #333; border: 1px solid #444; color: #fff;
            height: 36px; border-radius: 18px; padding: 0 15px;
        }
        .btn-send {
            color: var(--accent); width: 36px; height: 36px; 
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background: rgba(255,255,255,0.1);
        }

        /* é¢‘é“åˆ—è¡¨ (ç±»ä¼¼ YouTube ä¾§è¾¹æ ) */
        #side-list { flex: 1; overflow-y: auto; padding: 10px; }
        .side-item {
            display: flex; gap: 10px; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .side-img { width: 80px; height: 45px; background: #000; object-fit: cover; border-radius: 4px; }
        
        /* åŠ¨ç”» */
        @keyframes blink { 50% { opacity: 0; } }
        .triggering { color: #fff !important; text-shadow: 0 0 15px var(--accent); }

        /* æç¤º */
        #toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 6px;
            display: none; z-index: 9999;
        }
    </style>
</head>
<body>

<div id="view-lobby">
    <header>
        <div class="logo" id="logo-btn">OSB<span style="font-size:12px;opacity:0.6">PRO</span></div>
        <div class="search-wrap">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-inp" id="search-inp" placeholder="æœç´¢...">
        </div>
    </header>
    
    <div id="nav-tags"></div>
    
    <div id="grid">
        <div style="grid-column:1/-1; text-align:center; padding:50px; color:#666;">
            <i class="fas fa-circle-notch fa-spin"></i> ç³»ç»ŸåŠ è½½ä¸­...
        </div>
    </div>
</div>

<div id="view-room">
    <div id="video-wrap">
        <video id="player" playsinline webkit-playsinline controls></video>
        <canvas id="danmaku-canvas"></canvas>
        <div class="vid-overlay">
            <div class="btn-back" onclick="closeRoom()"><i class="fas fa-chevron-down"></i></div>
            <div class="btn-back" onclick="toggleFull()"><i class="fas fa-expand"></i></div>
        </div>
    </div>

    <div id="room-controls">
        <div class="info-bar">
            <div>
                <div class="ch-title" id="room-title">é¢‘é“åç§°</div>
                <div style="font-size:12px; color:#666; margin-top:4px;">çº¿è·¯: HLS | å¼¹å¹•: åœ¨çº¿</div>
            </div>
            <div class="live-badge" id="room-live-tag"><div class="live-dot"></div> LIVE</div>
        </div>

        <div class="chat-bar">
            <div class="btn-send" onclick="toggleDm()"><i class="fas fa-comment-dots" id="dm-icon"></i></div>
            <input type="text" class="chat-inp" id="dm-inp" placeholder="å‘å¼¹å¹• (å…¨ç½‘åŒæ­¥)...">
            <div class="btn-send" onclick="sendDm()"><i class="fas fa-paper-plane"></i></div>
        </div>

        <div id="side-list"></div>
    </div>
</div>

<div id="toast"></div>

<script>
    // ================= ç³»ç»Ÿé…ç½® =================
    const CONFIG = {
        safeUrl: 'https://raw.githubusercontent.com/satan-1412/live/refs/heads/main/no%20sex/TV_1(no%20sex).m3u8',
        rootUrl: 'https://raw.githubusercontent.com/satan-1412/live/main/TV.m3u8',
        mqtt: 'wss://broker.emqx.io:8084/mqtt',
        prefix: 'osb/v6/'
    };

    let app = { mode: 'SAFE', data: [], cat: 'ALL', hls: null, mqtt: null, topic: null };

    // ================= åˆå§‹åŒ– =================
    window.onload = () => {
        initLogo(); // ç¡®ä¿ Logo é€»è¾‘æœ€å…ˆè¿è¡Œ
        loadSource(CONFIG.safeUrl);
        initMQTT();
        initCanvas();
    };

    // ================= 1. Logo é•¿æŒ‰é€»è¾‘ (ä¿®å¤æ— æ³•åˆ‡æ¢) =================
    function initLogo() {
        const btn = document.getElementById('logo-btn');
        let timer;
        const start = () => {
            btn.classList.add('triggering');
            timer = setTimeout(switchMode, 10000); // 10ç§’
        };
        const end = () => {
            clearTimeout(timer);
            btn.classList.remove('triggering');
        };
        ['mousedown','touchstart'].forEach(e => btn.addEventListener(e, start));
        ['mouseup','touchend'].forEach(e => btn.addEventListener(e, end));
    }

    function switchMode() {
        if(app.mode === 'SAFE') {
            app.mode = 'ROOT';
            document.body.classList.add('root-mode');
            showToast("ğŸ”“ éšç§æ¨¡å¼");
            loadSource(CONFIG.rootUrl);
        } else {
            app.mode = 'SAFE';
            document.body.classList.remove('root-mode');
            showToast("ğŸ”’ å®‰å…¨æ¨¡å¼");
            loadSource(CONFIG.safeUrl);
        }
        if(navigator.vibrate) navigator.vibrate(500);
    }

    // ================= 2. æ•°æ®åŠ è½½ =================
    function loadSource(url) {
        showToast("æ­£åœ¨æ›´æ–°åˆ—è¡¨...");
        fetch(url + '?t=' + Date.now())
            .then(r => r.text())
            .then(parseM3U8)
            .catch(() => showToast("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"));
    }

    function parseM3U8(txt) {
        app.data = [];
        const lines = txt.split('\n');
        for(let i=0; i<lines.length; i++){
            const line = lines[i].trim();
            if(line.startsWith('#EXTINF')){
                const info = line.split(',')[1] || 'é¢‘é“';
                const logo = (line.match(/tvg-logo="([^"]+)"/) || [])[1];
                const group = (line.match(/group-title="([^"]+)"/) || [])[1] || 'å…¶ä»–';
                const url = lines[i+1] ? lines[i+1].trim() : '';
                if(url && url.startsWith('http')) {
                    app.data.push({ title: info, logo: logo, group: group, url: url });
                }
            }
        }
        renderLobby();
    }

    // ================= 3. æ¸²æŸ“å¤§å… =================
    function renderLobby() {
        // æ¸²æŸ“åˆ†ç±»
        const groups = new Set(['ALL']);
        app.data.forEach(d => groups.add(d.group));
        const tagBox = document.getElementById('nav-tags');
        tagBox.innerHTML = '';
        groups.forEach(g => {
            const t = document.createElement('div');
            t.className = `tag ${g === app.cat ? 'active' : ''}`;
            t.innerText = g;
            t.onclick = () => { app.cat = g; renderLobby(); };
            tagBox.appendChild(t);
        });

        // æ¸²æŸ“å¡ç‰‡
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        const search = document.getElementById('search-inp').value.toLowerCase();
        
        const list = app.data.filter(d => {
            if(app.cat !== 'ALL' && d.group !== app.cat) return false;
            if(search && !d.title.toLowerCase().includes(search)) return false;
            return true;
        });

        if(list.length === 0) grid.innerHTML = '<div style="padding:20px;color:#666">æ— ç»“æœ</div>';

        list.forEach(d => {
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => openRoom(d); // ç‚¹å‡»è¿›å…¥æˆ¿é—´

            let img = `<div class="card-fallback"><i class="fas fa-tv"></i></div>`;
            if(d.logo) img = `<img src="${d.logo}" class="card-img" onerror="this.style.display='none'">`;

            card.innerHTML = `<div class="card-img-box">${img}</div><div class="card-name">${d.title}</div>`;
            grid.appendChild(card);
        });
        
        // åŒæ—¶åˆ·æ–°æˆ¿é—´å†…çš„ä¾§è¾¹æ 
        renderSideList(list);
    }
    
    document.getElementById('search-inp').addEventListener('input', renderLobby);

    function renderSideList(list) {
        const side = document.getElementById('side-list');
        side.innerHTML = '';
        list.slice(0, 20).forEach(d => { // åªæ˜¾ç¤ºå‰20ä¸ªé˜²æ­¢å¡é¡¿
            const item = document.createElement('div');
            item.className = 'side-item';
            item.onclick = () => { openRoom(d); }; // åˆ‡å°
            let img = '';
            if(d.logo) img = `<img src="${d.logo}" class="side-img">`;
            item.innerHTML = `${img}<div style="font-size:13px;color:#ccc;display:flex;align-items:center">${d.title}</div>`;
            side.appendChild(item);
        });
    }

    // ================= 4. æ’­æ”¾å®¤é€»è¾‘ (æ ¸å¿ƒä¿®å¤) =================
    const video = document.getElementById('player');
    
    function openRoom(d) {
        document.getElementById('view-room').classList.add('active');
        document.getElementById('room-title').innerText = d.title;
        
        // 1. YouTube ç‰¹æ®Šå¤„ç† (Iframe æ¨¡å¼)
        if (d.url.includes('youtube.com') || d.url.includes('youtu.be')) {
            loadYouTube(d.url);
        } else {
            loadHLS(d.url);
        }

        // 2. åˆ‡æ¢å¼¹å¹•é¢‘é“
        joinChannel(d.title);
    }

    function closeRoom() {
        document.getElementById('view-room').classList.remove('active');
        video.pause();
        // æ¸…é™¤ Iframe
        const wrap = document.getElementById('video-wrap');
        const iframe = wrap.querySelector('iframe');
        if(iframe) iframe.remove();
        video.style.display = 'block';
    }

    function loadHLS(url) {
        const wrap = document.getElementById('video-wrap');
        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„ iframe
        const iframe = wrap.querySelector('iframe');
        if(iframe) iframe.remove();
        video.style.display = 'block';

        if(Hls.isSupported()) {
            if(app.hls) app.hls.destroy();
            app.hls = new Hls();
            app.hls.loadSource(url);
            app.hls.attachMedia(video);
            app.hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else {
            video.src = url;
            video.play();
        }
        
        // ç›‘å¬æ˜¯å¦ä¸ºç›´æ’­
        video.onloadedmetadata = () => {
            const isLive = video.duration === Infinity;
            document.getElementById('room-live-tag').style.display = isLive ? 'flex' : 'none';
        };
    }

    function loadYouTube(url) {
        // æå– Video ID
        let vid = '';
        if(url.includes('v=')) vid = url.split('v=')[1].split('&')[0];
        else if(url.includes('youtu.be/')) vid = url.split('youtu.be/')[1];

        if(vid) {
            video.pause();
            video.style.display = 'none';
            const wrap = document.getElementById('video-wrap');
            let iframe = wrap.querySelector('iframe');
            if(!iframe) {
                iframe = document.createElement('iframe');
                wrap.appendChild(iframe);
            }
            // ä½¿ç”¨ embed æ’­æ”¾ï¼Œ100% èƒ½æ’­
            iframe.src = `https://www.youtube.com/embed/${vid}?autoplay=1&playsinline=1`;
            iframe.allow = "autoplay; encrypted-media; picture-in-picture";
        }
    }

    function toggleFull() {
        const wrap = document.getElementById('video-wrap');
        if(!document.fullscreenElement) {
             wrap.requestFullscreen().catch(e => {
                 wrap.classList.toggle('fullscreen'); // iOS å…¼å®¹
             });
        } else {
            document.exitFullscreen();
        }
    }

    // ================= 5. å¼¹å¹• (MQTT åˆ†é¢‘) =================
    const canvas = document.getElementById('danmaku-canvas');
    const ctx = canvas.getContext('2d');
    let dms = []; let dmRaf; let dmOn = true;

    function initMQTT() {
        try {
            app.mqtt = mqtt.connect(CONFIG.mqtt);
            app.mqtt.on('connect', () => console.log('MQTT OK'));
            app.mqtt.on('message', (top, msg) => fireDm(msg.toString(), false));
        } catch(e){}
    }

    function joinChannel(title) {
        if(!app.mqtt) return;
        const topic = CONFIG.prefix + btoa(encodeURIComponent(title)).replace(/=/g,'');
        if(app.topic) app.mqtt.unsubscribe(app.topic);
        app.topic = topic;
        app.mqtt.subscribe(topic);
        dms = []; // æ¸…å±
    }

    function sendDm() {
        const inp = document.getElementById('dm-inp');
        const txt = inp.value.trim();
        if(!txt) return;
        if(app.mqtt && app.topic) app.mqtt.publish(app.topic, txt);
        fireDm(txt, true);
        inp.value = '';
    }

    function initCanvas() {
        resize();
        window.addEventListener('resize', resize);
        loop();
    }
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight * 0.4; // åªåœ¨è§†é¢‘åŒºåŸŸæ˜¾ç¤º
        ctx.font = "bold 20px Arial";
    }
    function fireDm(txt, isSelf) {
        dms.push({
            t: txt, x: canvas.width, y: 30 + Math.random()*(canvas.height-60),
            c: isSelf ? '#00ff88' : '#fff', s: 2+Math.random()
        });
    }
    function loop() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(dmOn) {
            for(let i=0;i<dms.length;i++){
                let d=dms[i]; d.x-=d.s;
                ctx.fillStyle=d.c; ctx.strokeStyle='#000'; ctx.lineWidth=2;
                ctx.strokeText(d.t,d.x,d.y); ctx.fillText(d.t,d.x,d.y);
                if(d.x<-500) {dms.splice(i,1);i--;}
            }
        }
        dmRaf = requestAnimationFrame(loop);
    }
    function toggleDm() {
        dmOn = !dmOn;
        document.getElementById('dm-icon').className = dmOn ? 'fas fa-comment-dots' : 'fas fa-comment-slash';
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }
</script>
</body>
</html>
