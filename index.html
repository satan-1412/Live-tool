<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OSB PLAYER | LIVE</title>
    
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* ================== V5.0 竖屏直播架构 ================== */
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --accent: #00ff88;
            --text-main: #fff;
            --text-sub: #888;
            --video-height: 35vh; /* 视频区域高度 */
        }
        
        body.root-mode {
            --bg-color: #1a0510;
            --panel-bg: #2d0a1a;
            --accent: #ff0055;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-main); font-family: sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; transition: 0.5s; }

        /* --- 1. 视频区域 (固定顶部) --- */
        #theater-stage {
            width: 100%; height: var(--video-height);
            background: #000; position: relative; z-index: 100;
            transition: height 0.3s;
            flex-shrink: 0;
        }
        
        /* 全屏模式样式 */
        #theater-stage.fullscreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
        }

        video { width: 100%; height: 100%; object-fit: contain; }

        /* 弹幕层 */
        #danmaku-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        /* 覆盖 UI (标题, 全屏按钮, 发送框) - 全屏时显示，平时隐藏或精简 */
        .overlay-ui {
            position: absolute; left: 0; width: 100%;
            transition: opacity 0.3s; opacity: 0; /* 默认隐藏，点击显示 */
            pointer-events: none; /* 让点击穿透到 video */
            display: flex; flex-direction: column; justify-content: space-between;
            height: 100%; z-index: 20;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.8) 100%);
        }
        .overlay-ui.visible { opacity: 1; pointer-events: auto; }

        .ov-top { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        .ov-title { font-size: 14px; color: #fff; font-weight: bold; text-shadow: 0 1px 2px #000; }
        .live-badge { background: #cc0000; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .live-dot { width: 6px; height: 6px; background: #fff; border-radius: 50%; animation: blink 1s infinite; }
        
        /* 底部控制条 */
        .ov-bottom { padding: 10px 15px; display: flex; gap: 10px; align-items: center; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .dm-input {
            flex: 1; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px; color: #fff; padding: 8px 15px; font-size: 13px; backdrop-filter: blur(5px);
        }
        .icon-btn { color: #fff; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 18px; text-shadow: 0 1px 3px #000; cursor: pointer; }

        /* 进度条 (仅点播显示) */
        .progress-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.3);
            z-index: 25; display: none; /* 默认隐藏 */
        }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; }

        /* --- 2. 信息与选台区域 (下半部分) --- */
        #info-panel {
            flex: 1; background: var(--bg-color);
            display: flex; flex-direction: column; overflow: hidden;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* 频道信息栏 */
        .channel-header {
            padding: 15px; background: var(--panel-bg);
            display: flex; justify-content: space-between; align-items: start;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .ch-info h2 { margin: 0; font-size: 16px; color: var(--text-main); }
        .ch-info p { margin: 5px 0 0; font-size: 12px; color: var(--text-sub); }
        .ch-logo { width: 50px; height: 30px; object-fit: contain; background: #000; border-radius: 4px; }
        
        /* 备注栏 (泰国台提示) */
        #remark-box {
            margin: 10px 15px; padding: 10px; background: rgba(255,165,0,0.1);
            border: 1px solid rgba(255,165,0,0.3); border-radius: 6px;
            color: #ffaa00; font-size: 12px; display: none;
        }

        /* 选台列表 */
        .list-tabs {
            padding: 10px 15px; display: flex; gap: 10px; overflow-x: auto;
            border-bottom: 1px solid rgba(255,255,255,0.05); flex-shrink: 0;
        }
        .tab-btn { padding: 5px 12px; background: rgba(255,255,255,0.1); border-radius: 15px; font-size: 12px; color: #888; white-space: nowrap; cursor: pointer; }
        .tab-btn.active { background: var(--accent); color: #000; font-weight: bold; }

        #channel-list {
            flex: 1; overflow-y: auto; padding: 10px;
        }
        .list-item {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer;
        }
        .list-item.active { background: rgba(255,255,255,0.05); border-left: 3px solid var(--accent); }
        .li-img { width: 60px; height: 34px; background: #000; object-fit: cover; border-radius: 4px; }
        .li-title { font-size: 13px; color: #ddd; flex: 1; }
        .li-status { font-size: 10px; color: #555; }

        @keyframes blink { 50% { opacity: 0; } }
        
        /* Logo 彩蛋 */
        .logo-trigger {
            position: fixed; bottom: 20px; right: 20px; opacity: 0.1;
            font-weight: 900; font-size: 20px; color: var(--accent); z-index: 9999;
        }
        .triggering { opacity: 1; text-shadow: 0 0 10px var(--accent); }
        
        /* 错误提示 */
        #toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); padding: 12px 20px; border-radius: 8px;
            color: #fff; font-size: 14px; display: none; z-index: 2000;
        }
    </style>
</head>
<body>

<div id="theater-stage" onclick="toggleControls()">
    <video id="video-player" playsinline webkit-playsinline></video>
    <canvas id="danmaku-layer"></canvas>
    
    <div class="overlay-ui" id="ui-layer" onclick="event.stopPropagation()"> <div class="ov-top">
            <div class="ov-title" id="player-title">未选择频道</div>
            <div class="live-badge" id="live-tag"><div class="live-dot"></div> LIVE</div>
        </div>
        
        <div class="ov-bottom">
            <div class="icon-btn" onclick="toggleDanmaku()"><i class="fas fa-comment-dots" id="dm-icon"></i></div>
            <input type="text" class="dm-input" id="dm-input" placeholder="发送弹幕..." autocomplete="off">
            <div class="icon-btn" onclick="sendDm()" style="color:var(--accent)"><i class="fas fa-paper-plane"></i></div>
            <div class="icon-btn" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></div>
        </div>
    </div>
    
    <div class="progress-bar" id="vod-progress"><div class="progress-fill" id="vod-fill"></div></div>
</div>

<div id="info-panel">
    <div class="channel-header">
        <div class="ch-info">
            <h2 id="info-title">OSB TV</h2>
            <p id="info-desc">请选择频道开始观看</p>
        </div>
        <img id="info-logo" class="ch-logo" style="opacity:0">
    </div>

    <div id="remark-box">
        <i class="fas fa-info-circle"></i> <b>信号提示：</b> 
        <span id="remark-text">该频道可能需要移动数据网络才能播放。</span>
    </div>

    <div class="list-tabs" id="category-tabs"></div>
    <div id="channel-list">
        <div style="text-align:center; padding:30px; color:#555;">
            <i class="fas fa-satellite-dish fa-spin"></i> 正在搜索信号...
        </div>
    </div>
</div>

<div class="logo-trigger" id="logo-btn">OSB</div>

<div id="toast"></div>

<script>
    // ================= 系统配置 =================
    const CONFIG = {
        safeUrl: 'https://raw.githubusercontent.com/satan-1412/live/refs/heads/main/no%20sex/TV_1(no%20sex).m3u8',
        rootUrl: 'https://raw.githubusercontent.com/satan-1412/live/main/TV.m3u8',
        mqttBroker: 'wss://broker.emqx.io:8084/mqtt',
        // 注意：这里不再是 global topic，而是前缀
        mqttPrefix: 'osb/channel/' 
    };

    let app = {
        mode: 'SAFE',
        data: [],
        cat: 'ALL',
        currentCh: null, // 当前频道对象
        hls: null,
        mqtt: null,
        currentTopic: null
    };

    // ================= 初始化 =================
    window.onload = () => {
        initLogo();
        initCanvas();
        loadSource(CONFIG.safeUrl);
        initMQTT(); // 提前连接
    };

    // ================= 1. 数据逻辑 =================
    function loadSource(url) {
        showToast("更新频道列表中...");
        fetch(url + '?t=' + Date.now())
            .then(r => r.text())
            .then(txt => parseM3U8(txt))
            .catch(e => showToast("列表加载失败"));
    }

    function parseM3U8(txt) {
        app.data = [];
        const lines = txt.split('\n');
        for(let i=0; i<lines.length; i++){
            const line = lines[i].trim();
            if(line.startsWith('#EXTINF')){
                const info = line.split(',')[1] || '未知频道';
                const logo = (line.match(/tvg-logo="([^"]+)"/) || [])[1];
                const group = (line.match(/group-title="([^"]+)"/) || [])[1] || '其它';
                const url = lines[i+1] ? lines[i+1].trim() : '';
                if(url && url.startsWith('http')){
                    app.data.push({title: info, logo: logo, group: group, url: url});
                }
            }
        }
        renderTabs();
        renderList();
        
        // 如果有数据，默认选中第一个
        if(app.data.length > 0 && !app.currentCh) {
             // 仅展示信息，不自动播放，免得吵
             updateInfoPanel(app.data[0]);
        }
    }

    // ================= 2. 渲染 UI =================
    function renderTabs() {
        const groups = new Set(['ALL']);
        app.data.forEach(d => groups.add(d.group));
        const bar = document.getElementById('category-tabs');
        bar.innerHTML = '';
        groups.forEach(g => {
            const btn = document.createElement('div');
            btn.className = `tab-btn ${g === app.cat ? 'active' : ''}`;
            btn.innerText = g;
            btn.onclick = () => { app.cat = g; renderTabs(); renderList(); };
            bar.appendChild(btn);
        });
    }

    function renderList() {
        const list = document.getElementById('channel-list');
        list.innerHTML = '';
        
        const filtered = app.data.filter(d => app.cat === 'ALL' || d.group === app.cat);
        
        filtered.forEach(d => {
            const item = document.createElement('div');
            item.className = `list-item ${app.currentCh === d ? 'active' : ''}`;
            item.onclick = () => playChannel(d);
            
            let imgHtml = `<div style="width:60px;height:34px;background:#333;display:flex;align-items:center;justify-content:center;color:#555;border-radius:4px;"><i class="fas fa-tv"></i></div>`;
            if(d.logo) imgHtml = `<img src="${d.logo}" class="li-img" onerror="this.style.display='none'">`;
            
            item.innerHTML = `
                ${imgHtml}
                <div class="li-title">${d.title}</div>
                <div class="li-status"><i class="fas fa-play-circle"></i></div>
            `;
            list.appendChild(item);
        });
    }

    function updateInfoPanel(d) {
        document.getElementById('info-title').innerText = d.title;
        document.getElementById('info-desc').innerText = `分类: ${d.group} | 线路: HLS`;
        const logo = document.getElementById('info-logo');
        if(d.logo) { logo.src = d.logo; logo.style.opacity = 1; }
        else { logo.style.opacity = 0; }
        
        // 备注逻辑：针对泰国台或特定关键词显示提示
        const remark = document.getElementById('remark-box');
        const remarkTxt = document.getElementById('remark-text');
        
        if(d.title.includes("Thai") || d.url.includes("youtube") || d.title.includes("油管")) {
            remark.style.display = 'block';
            remarkTxt.innerText = "如无法播放，请尝试使用手机流量或切换移动端浏览器。";
        } else {
            remark.style.display = 'none';
        }
    }

    // ================= 3. 播放核心 =================
    const video = document.getElementById('video-player');
    const stage = document.getElementById('theater-stage');
    const ui = document.getElementById('ui-layer');

    function playChannel(d) {
        app.currentCh = d;
        renderList(); // 更新高亮
        updateInfoPanel(d);
        
        // 1. 设置视频
        document.getElementById('player-title').innerText = d.title;
        if(Hls.isSupported()) {
            if(app.hls) app.hls.destroy();
            app.hls = new Hls({
                // 关键：针对 HTTP 图片/流的配置
                xhrSetup: function(xhr, url) {
                    xhr.withCredentials = false; // 避免 CORS 问题
                }
            });
            app.hls.loadSource(d.url);
            app.hls.attachMedia(video);
            app.hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else if(video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = d.url;
            video.play();
        }

        // 2. 切换弹幕房间 (独立频道)
        switchMqttRoom(d.title);
        
        // 3. 自动检测是直播还是点播
        video.onloadedmetadata = () => {
            const isLive = video.duration === Infinity || video.duration > 100000;
            const badge = document.getElementById('live-tag');
            const progress = document.getElementById('vod-progress');
            
            if(isLive) {
                badge.style.display = 'flex';
                progress.style.display = 'none';
            } else {
                badge.style.display = 'none';
                progress.style.display = 'block';
            }
        };
        
        // 点播进度条更新
        video.ontimeupdate = () => {
            if(video.duration && video.duration !== Infinity) {
                const pct = (video.currentTime / video.duration) * 100;
                document.getElementById('vod-fill').style.width = pct + '%';
            }
        };
    }

    // 控制 UI 显示/隐藏
    let uiTimer;
    function toggleControls() {
        if(ui.classList.contains('visible')) {
            ui.classList.remove('visible');
        } else {
            ui.classList.add('visible');
            // 3秒后自动隐藏
            clearTimeout(uiTimer);
            uiTimer = setTimeout(() => {
                // 如果正在输入，不隐藏
                if(document.activeElement !== document.getElementById('dm-input')) {
                    ui.classList.remove('visible');
                }
            }, 4000);
        }
    }

    function toggleFullScreen() {
        if(!document.fullscreenElement) {
            stage.requestFullscreen().catch(e => {
                // 如果API不支持，使用 CSS 伪全屏
                stage.classList.toggle('fullscreen');
            });
        } else {
            document.exitFullscreen();
        }
    }
    
    // 全屏变化监听 (处理 CSS 伪全屏的回退)
    document.addEventListener('fullscreenchange', () => {
        if(!document.fullscreenElement) stage.classList.remove('fullscreen');
    });

    // ================= 4. 独立弹幕系统 (MQTT 分频) =================
    // 频道 ID 生成器：简单的 Base64 编码频道名，确保唯一
    function getChannelTopic(title) {
        // 去除空格和特殊字符防止 MQTT 报错
        const safeId = btoa(encodeURIComponent(title)).replace(/=/g, '');
        return CONFIG.mqttPrefix + safeId;
    }

    function initMQTT() {
        try {
            app.mqtt = mqtt.connect(CONFIG.mqttBroker);
            app.mqtt.on('connect', () => { console.log("MQTT Connected"); });
            app.mqtt.on('message', (topic, msg) => {
                if(topic === app.currentTopic) {
                    fireDm(msg.toString(), false);
                }
            });
        } catch(e) { console.error(e); }
    }

    function switchMqttRoom(title) {
        if(!app.mqtt) return;
        const newTopic = getChannelTopic(title);
        
        // 1. 取消订阅旧频道
        if(app.currentTopic) {
            app.mqtt.unsubscribe(app.currentTopic);
        }
        
        // 2. 清空屏幕弹幕
        dms = [];
        ctx.clearRect(0,0,canvas.width,canvas.height);
        
        // 3. 订阅新频道
        app.currentTopic = newTopic;
        app.mqtt.subscribe(newTopic);
        showToast("已连接弹幕频道: " + title);
    }

    function sendDm() {
        const inp = document.getElementById('dm-input');
        const txt = inp.value.trim();
        if(!txt) return;
        
        if(app.mqtt && app.currentTopic) {
            app.mqtt.publish(app.currentTopic, txt);
        }
        fireDm(txt, true);
        inp.value = '';
        // 保持 UI 显示
        clearTimeout(uiTimer);
    }

    // Canvas 绘制
    const canvas = document.getElementById('danmaku-layer');
    const ctx = canvas.getContext('2d');
    let dms = [];
    let dmRaf;
    let isDmOn = true;

    function initCanvas() {
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        loop();
    }
    function resizeCanvas() {
        canvas.width = stage.offsetWidth;
        canvas.height = stage.offsetHeight;
        ctx.font = "bold 20px Arial";
    }

    function fireDm(text, isSelf) {
        dms.push({
            text: text,
            x: canvas.width,
            y: 30 + Math.random() * (canvas.height - 60),
            speed: 2 + Math.random(),
            color: isSelf ? '#00ff88' : '#fff'
        });
    }

    function loop() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(isDmOn) {
            for(let i=0; i<dms.length; i++) {
                let d = dms[i];
                d.x -= d.speed;
                ctx.fillStyle = d.color;
                ctx.strokeStyle = 'black'; ctx.lineWidth = 2;
                ctx.strokeText(d.text, d.x, d.y);
                ctx.fillText(d.text, d.x, d.y);
                if(d.x < -1000) { dms.splice(i,1); i--; }
            }
        }
        dmRaf = requestAnimationFrame(loop);
    }

    function toggleDanmaku() {
        isDmOn = !isDmOn;
        document.getElementById('dm-icon').className = isDmOn ? 'fas fa-comment-dots' : 'fas fa-comment-slash';
        showToast(isDmOn ? "弹幕已开" : "弹幕已关");
    }

    // ================= 5. 彩蛋逻辑 =================
    function initLogo() {
        const btn = document.getElementById('logo-btn');
        let timer;
        const start = () => {
            btn.classList.add('triggering');
            timer = setTimeout(() => {
                toggleMode();
            }, 10000);
        };
        const end = () => {
            clearTimeout(timer);
            btn.classList.remove('triggering');
        };
        ['mousedown','touchstart'].forEach(e => btn.addEventListener(e, start));
        ['mouseup','touchend'].forEach(e => btn.addEventListener(e, end));
    }

    function toggleMode() {
        if(app.mode === 'SAFE') {
            app.mode = 'ROOT';
            document.body.classList.add('root-mode');
            showToast("隐私模式已解锁");
            loadSource(CONFIG.rootUrl);
        } else {
            app.mode = 'SAFE';
            document.body.classList.remove('root-mode');
            showToast("安全模式");
            loadSource(CONFIG.safeUrl);
        }
        if(navigator.vibrate) navigator.vibrate(500);
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }
</script>
</body>
</html>
