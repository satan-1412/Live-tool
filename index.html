<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OSB PLAYER | PRO</title>
    
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* ================== V6.0 视觉架构 ================== */
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --primary: #00ff88;
            --text: #fff;
            --text-gray: #888;
        }
        
        body.root-mode {
            --bg: #1a0510;
            --surface: #2d0a1a;
            --primary: #ff0055;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; overflow: hidden; }

        /* ================== 页面切换逻辑 ================== */
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            transition: transform 0.3s ease-in-out;
            background: var(--bg);
        }

        /* 默认显示大厅，隐藏播放器 */
        #page-lobby { z-index: 10; transform: translateX(0); }
        #page-player { z-index: 20; transform: translateX(100%); }
        
        /* 激活播放器时的状态 */
        body.player-active #page-lobby { transform: translateX(-30%); }
        body.player-active #page-player { transform: translateX(0); }

        /* ================== 1. 大厅 (Lobby) ================== */
        header {
            padding: 12px 15px; background: rgba(30,30,30,0.95);
            display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo { font-size: 22px; font-weight: 900; color: var(--primary); letter-spacing: -1px; transition: 0.3s; }
        .logo.triggering { text-shadow: 0 0 15px var(--primary); color: #fff; }

        .search-wrap { flex: 1; position: relative; }
        .search-input { width: 100%; background: #333; border: none; border-radius: 6px; padding: 8px 10px 8px 35px; color: #fff; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #777; }

        #nav-tabs {
            padding: 10px 15px; display: flex; gap: 10px; overflow-x: auto;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .tab-btn {
            padding: 6px 14px; background: rgba(255,255,255,0.1); border-radius: 20px;
            font-size: 13px; color: #ccc; white-space: nowrap;
        }
        .tab-btn.active { background: var(--primary); color: #000; font-weight: bold; }

        #lobby-grid {
            flex: 1; padding: 15px; overflow-y: auto;
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
            align-content: start;
        }
        @media (min-width: 768px) { #lobby-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); } }

        .card { background: var(--surface); border-radius: 8px; overflow: hidden; position: relative; }
        .card-img-box { width: 100%; aspect-ratio: 16/9; background: #000; position: relative; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-name { padding: 8px; font-size: 13px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ================== 2. 播放器 (Player) ================== */
        /* 上半部分：视频区 */
        #video-section {
            width: 100%; height: 35vh; background: #000; position: relative;
            flex-shrink: 0; z-index: 50; transition: height 0.3s;
        }
        #video-section.fullscreen { position: fixed; height: 100%; z-index: 100; }

        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* 弹幕画布 */
        #dm-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        
        /* 顶部浮层 (返回 + 标题 + 信号标) */
        .player-header {
            position: absolute; top: 0; left: 0; width: 100%; height: 50px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
            z-index: 30; pointer-events: none; /* 让点击穿透 */
        }
        .btn-back { pointer-events: auto; padding: 10px; font-size: 20px; color: #fff; filter: drop-shadow(0 0 2px #000); }
        .player-info { flex: 1; margin: 0 15px; color: #fff; font-size: 14px; font-weight: bold; text-shadow: 0 1px 2px #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .live-badge { 
            background: #cc0000; color: #fff; padding: 2px 6px; border-radius: 3px; 
            font-size: 10px; font-weight: bold; display: none; align-items: center; gap: 4px;
        }
        .live-dot { width: 6px; height: 6px; background: #fff; border-radius: 50%; animation: blink 1s infinite; }

        /* 全屏按钮 (浮动在右下角) */
        .btn-fullscreen {
            position: absolute; bottom: 10px; right: 10px; z-index: 30;
            color: #fff; padding: 10px; font-size: 18px; filter: drop-shadow(0 0 2px #000);
            cursor: pointer; opacity: 0.8;
        }

        /* 下半部分：控制区 */
        #ctrl-section { flex: 1; display: flex; flex-direction: column; background: var(--bg); overflow: hidden; }
        
        /* 频道信息条 */
        .ch-bar {
            padding: 10px 15px; background: var(--surface); border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; gap: 10px;
        }
        .ch-logo { width: 50px; height: 30px; object-fit: contain; background: #000; border-radius: 4px; }
        .ch-meta h3 { margin: 0; font-size: 15px; color: var(--text); }
        .ch-meta p { margin: 2px 0 0; font-size: 12px; color: var(--text-gray); }

        /* 选台列表 */
        .playlist { flex: 1; overflow-y: auto; padding: 10px; }
        .play-item {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05); border-radius: 4px;
        }
        .play-item.active { background: rgba(255,255,255,0.05); border-left: 3px solid var(--primary); }
        .pi-title { flex: 1; font-size: 13px; color: #ddd; }

        /* 底部弹幕输入 */
        .dm-bar {
            padding: 10px 15px; background: #1a1a1a; border-top: 1px solid #333;
            display: flex; gap: 10px; align-items: center; padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .dm-input {
            flex: 1; height: 36px; border-radius: 18px; border: none; background: #333;
            padding: 0 15px; color: #fff; font-size: 14px;
        }
        .dm-send { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: #000; display: flex; align-items: center; justify-content: center; }

        @keyframes blink { 50% { opacity: 0; } }
        .loading { grid-column:1/-1; text-align:center; padding:50px; color:#666; }
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 6px; display: none; z-index: 999; }
    </style>
</head>
<body>

<div id="page-lobby" class="page">
    <header>
        <div class="logo" id="logo-trigger">OSB<span style="font-size:12px;opacity:0.6">PRO</span></div>
        <div class="search-wrap">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="search-input" placeholder="搜索频道...">
        </div>
    </header>

    <div id="nav-tabs"></div>
    <div id="lobby-grid">
        <div class="loading"><i class="fas fa-circle-notch fa-spin"></i> 系统连接中...</div>
    </div>
</div>

<div id="page-player" class="page">
    <div id="video-section">
        <video id="video" playsinline webkit-playsinline controls></video>
        <canvas id="dm-canvas"></canvas>
        
        <div class="player-header">
            <div class="btn-back" onclick="closePlayer()"><i class="fas fa-chevron-left"></i></div>
            <div class="player-info" id="p-title">加载中...</div>
            <div class="live-badge" id="p-live"><div class="live-dot"></div> LIVE</div>
        </div>

        <div class="btn-fullscreen" onclick="toggleFS()"><i class="fas fa-expand"></i></div>
    </div>

    <div id="ctrl-section">
        <div class="ch-bar">
            <img id="p-logo" class="ch-logo" style="opacity:0">
            <div class="ch-meta">
                <h3 id="p-name">--</h3>
                <p id="p-group">线路: HLS | 状态: 连接中</p>
            </div>
        </div>
        
        <div class="playlist" id="playlist"></div>
        
        <div class="dm-bar">
            <input type="text" class="dm-input" id="dm-input" placeholder="发送全网弹幕...">
            <div class="dm-send" onclick="sendDm()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    // ================= 系统配置 =================
    const CONFIG = {
        safeUrl: 'https://raw.githubusercontent.com/satan-1412/live/refs/heads/main/no%20sex/TV_1(no%20sex).m3u8',
        rootUrl: 'https://raw.githubusercontent.com/satan-1412/live/main/TV.m3u8',
        mqttBroker: 'wss://broker.emqx.io:8084/mqtt',
        mqttPrefix: 'osb/ch/'
    };

    let app = {
        mode: 'SAFE',
        data: [],
        cat: 'ALL',
        currentCh: null,
        mqtt: null,
        topic: null
    };

    // ================= 核心初始化 =================
    window.onload = () => {
        initLogo(); // 优先保证彩蛋可用
        initMQTT();
        initCanvas();
        loadData(CONFIG.safeUrl);
    };

    // ================= 1. 数据加载 =================
    function loadData(url) {
        showToast("正在同步数据...");
        fetch(url + '?t=' + Date.now())
            .then(r => r.text())
            .then(txt => parseM3U8(txt))
            .catch(e => showToast("加载失败"));
    }

    function parseM3U8(txt) {
        app.data = [];
        const lines = txt.split('\n');
        for(let i=0; i<lines.length; i++){
            const line = lines[i].trim();
            if(line.startsWith('#EXTINF')){
                const info = line.split(',')[1] || '频道';
                const logo = (line.match(/tvg-logo="([^"]+)"/) || [])[1];
                const group = (line.match(/group-title="([^"]+)"/) || [])[1] || '其他';
                const url = lines[i+1] ? lines[i+1].trim() : '';
                if(url && url.startsWith('http')) app.data.push({title:info, logo:logo, group:group, url:url});
            }
        }
        renderLobby();
    }

    // ================= 2. 大厅渲染 =================
    function renderLobby() {
        // 渲染分类 Tab
        const groups = new Set(['ALL']);
        app.data.forEach(d => groups.add(d.group));
        const tabs = document.getElementById('nav-tabs');
        tabs.innerHTML = '';
        groups.forEach(g => {
            const btn = document.createElement('div');
            btn.className = `tab-btn ${g === app.cat ? 'active' : ''}`;
            btn.innerText = g;
            btn.onclick = () => { app.cat = g; renderLobby(); };
            tabs.appendChild(btn);
        });

        // 渲染宫格
        const grid = document.getElementById('lobby-grid');
        grid.innerHTML = '';
        const search = document.getElementById('search-input').value.toLowerCase();
        
        const list = app.data.filter(d => {
            if(app.cat !== 'ALL' && d.group !== app.cat) return false;
            if(search && !d.title.toLowerCase().includes(search)) return false;
            return true;
        });

        if(list.length === 0) grid.innerHTML = '<div class="loading">无相关频道</div>';

        list.forEach(d => {
            const el = document.createElement('div');
            el.className = 'card';
            el.onclick = () => openPlayer(d);
            
            let img = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#444;font-size:24px;"><i class="fas fa-tv"></i></div>`;
            if(d.logo) img = `<img src="${d.logo}" class="card-img" onerror="this.style.display='none'">`;
            
            el.innerHTML = `<div class="card-img-box">${img}</div><div class="card-name">${d.title}</div>`;
            grid.appendChild(el);
        });
    }
    
    document.getElementById('search-input').addEventListener('input', renderLobby);

    // ================= 3. 播放器逻辑 (关键修复) =================
    const v = document.getElementById('video');
    const hls = new Hls({
        // 核心修复：允许跨域，不携带 Cookie，解决油管/泰国台问题
        xhrSetup: function(xhr, url) {
            xhr.withCredentials = false; 
        }
    });

    function openPlayer(d) {
        app.currentCh = d;
        document.body.classList.add('player-active');
        
        // 更新 UI
        document.getElementById('p-title').innerText = d.title;
        document.getElementById('p-name').innerText = d.title;
        document.getElementById('p-group').innerText = `分类: ${d.group}`;
        const logo = document.getElementById('p-logo');
        if(d.logo) { logo.src = d.logo; logo.style.opacity = 1; } else logo.style.opacity = 0;

        // 播放
        if(Hls.isSupported()) {
            hls.loadSource(d.url);
            hls.attachMedia(v);
            hls.on(Hls.Events.MANIFEST_PARSED, () => v.play());
        } else if(v.canPlayType('application/vnd.apple.mpegurl')) {
            v.src = d.url;
            v.play();
        }

        // 智能显示 LIVE 标
        v.onloadedmetadata = () => {
            const isLive = v.duration === Infinity || v.duration > 36000; // 简单判断
            document.getElementById('p-live').style.display = isLive ? 'flex' : 'none';
        };

        // 渲染下方同类列表
        renderPlaylist();
        // 切换弹幕房间
        switchTopic(d.title);
    }

    function closePlayer() {
        document.body.classList.remove('player-active');
        v.pause();
    }

    function renderPlaylist() {
        const list = document.getElementById('playlist');
        list.innerHTML = '';
        // 显示同分类下的频道
        const siblings = app.data.filter(d => d.group === app.currentCh.group);
        
        siblings.forEach(d => {
            const el = document.createElement('div');
            el.className = `play-item ${d === app.currentCh ? 'active' : ''}`;
            el.onclick = () => openPlayer(d); // 切换频道
            el.innerHTML = `<div class="pi-title">${d.title}</div><i class="fas fa-play-circle" style="color:#555"></i>`;
            list.appendChild(el);
        });
    }

    function toggleFS() {
        const sec = document.getElementById('video-section');
        if(!document.fullscreenElement) {
            sec.requestFullscreen().catch(()=>{});
            sec.classList.add('fullscreen');
        } else {
            document.exitFullscreen();
            sec.classList.remove('fullscreen');
        }
    }
    document.addEventListener('fullscreenchange', () => {
        if(!document.fullscreenElement) document.getElementById('video-section').classList.remove('fullscreen');
    });

    // ================= 4. 独立弹幕 (MQTT) =================
    const canvas = document.getElementById('dm-canvas');
    const ctx = canvas.getContext('2d');
    let dms = []; let dmRaf;

    function initMQTT() {
        try {
            app.mqtt = mqtt.connect(CONFIG.mqttBroker);
            app.mqtt.on('connect', () => console.log("MQTT OK"));
            app.mqtt.on('message', (t, m) => fireDm(m.toString(), false));
        } catch(e) {}
    }

    function switchTopic(title) {
        if(!app.mqtt) return;
        const newTopic = CONFIG.mqttPrefix + btoa(encodeURIComponent(title)).replace(/=/g,'');
        if(app.topic) app.mqtt.unsubscribe(app.topic);
        app.topic = newTopic;
        app.mqtt.subscribe(newTopic);
        dms = []; ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    function sendDm() {
        const inp = document.getElementById('dm-input');
        const txt = inp.value.trim();
        if(!txt) return;
        if(app.mqtt && app.topic) app.mqtt.publish(app.topic, txt);
        fireDm(txt, true);
        inp.value = '';
    }

    function initCanvas() {
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        loop();
    }
    function resizeCanvas() {
        canvas.width = document.getElementById('video-section').offsetWidth;
        canvas.height = document.getElementById('video-section').offsetHeight;
        ctx.font = "bold 22px Arial";
    }

    function fireDm(text, self) {
        dms.push({
            text: text, x: canvas.width, y: 30+Math.random()*(canvas.height-60),
            speed: 2+Math.random(), color: self?'#00ff88':'#fff'
        });
    }
    function loop() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        dms.forEach((d,i) => {
            d.x -= d.speed;
            ctx.fillStyle=d.color; ctx.strokeStyle='black'; ctx.lineWidth=2;
            ctx.strokeText(d.text,d.x,d.y); ctx.fillText(d.text,d.x,d.y);
            if(d.x<-500) dms.splice(i,1);
        });
        requestAnimationFrame(loop);
    }

    // ================= 5. 彩蛋 =================
    function initLogo() {
        const logo = document.getElementById('logo-trigger');
        let timer;
        const start = () => { logo.classList.add('triggering'); timer = setTimeout(switchMode, 10000); };
        const end = () => { clearTimeout(timer); logo.classList.remove('triggering'); };
        ['mousedown','touchstart'].forEach(e=>logo.addEventListener(e,start));
        ['mouseup','touchend'].forEach(e=>logo.addEventListener(e,end));
    }

    function switchMode() {
        const isSafe = app.mode === 'SAFE';
        app.mode = isSafe ? 'ROOT' : 'SAFE';
        document.body.classList.toggle('root-mode', isSafe);
        showToast(isSafe ? "隐私模式已解锁" : "已恢复安全模式");
        loadData(isSafe ? CONFIG.rootUrl : CONFIG.safeUrl);
        if(navigator.vibrate) navigator.vibrate(500);
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display='block';
        setTimeout(()=>t.style.display='none', 2000);
    }
</script>
</body>
</html>
