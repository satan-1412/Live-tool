<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="referrer" content="no-referrer">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>M3U/M3U8 Web Toolbox</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<style>
    /* --- 1. è§†è§‰å¤åŸï¼šæ·±è‰²é«˜çº§æ„Ÿ --- */
    :root { --bg:#050505; --surface:#141414; --surface-light:#1f1f1f; --primary:#3ea6ff; --danger:#ff4d4d; --success:#2ba640; --text:#fff; --gray:#aaa; --border:rgba(255,255,255,0.1); }
    *{box-sizing:border-box;margin:0;padding:0;outline:none;-webkit-tap-highlight-color:transparent}
    body{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow-x:hidden}
    
    /* å¯¼èˆªæ  */
    .navbar{height:60px;padding:0 20px;background:rgba(20,20,20,0.95);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;backdrop-filter:blur(10px)}
    .menu-btn{background:none;border:none;color:#fff;font-size:22px;padding:5px}
    .app-title{font-size:18px;font-weight:700;background:linear-gradient(90deg,var(--primary),#a54aff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:absolute;left:50%;transform:translateX(-50%);}
    .lang-btn{background:rgba(255,255,255,0.05);border:1px solid var(--border);color:#fff;padding:5px 10px;border-radius:15px;font-size:12px;display:flex;align-items:center;gap:5px}
    .lang-menu{position:absolute;top:110%;right:0;background:#222;border:1px solid var(--border);border-radius:8px;width:140px;display:none;flex-direction:column;overflow:hidden;box-shadow:0 5px 20px rgba(0,0,0,0.5)}
    .lang-menu.active{display:flex}
    .lang-item{padding:12px;font-size:13px;border-bottom:1px solid rgba(255,255,255,0.05)}
    
    /* ä¾§è¾¹æ  */
    .sidebar{position:fixed;top:0;left:0;height:100%;width:240px;background:#111;transform:translateX(-100%);transition:0.3s;z-index:200;display:flex;flex-direction:column;border-right:1px solid var(--border)}
    .sidebar.active{transform:translateX(0)}
    .sidebar-header{height:60px;display:flex;align-items:center;padding-left:20px;border-bottom:1px solid var(--border);font-weight:700;color:#888}
    .menu-item{padding:15px 20px;color:#fff;border-left:3px solid transparent;font-size:14px}
    .menu-item.active{border-left-color:var(--primary);color:var(--primary);background:rgba(62,166,255,0.05);font-weight:700}
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);opacity:0;visibility:hidden;transition:0.3s;z-index:150}
    .overlay.active{opacity:1;visibility:visible}

    .main-container{flex:1;padding:20px;width:100%;max-width:800px;margin:0 auto;overflow-y:auto;padding-bottom:100px}
    .section-view{display:none;animation:fadeIn 0.2s}.section-view.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1}}

    /* è“è‰²æ ‡é¢˜ä¸è¯´æ˜ (ä¿®å¤å¤šè¯­è¨€) */
    .section-title{font-size:20px;font-weight:700;margin:10px 0 15px;text-align:center;color:var(--primary)}
    .tips-box{background:rgba(62,166,255,0.06);border:1px solid rgba(62,166,255,0.15);border-radius:8px;padding:15px;margin-bottom:20px;font-size:13px;color:#ccc;line-height:1.6}
    .tips-title{color:var(--primary);font-weight:700;margin-bottom:6px;font-size:14px;display:flex;align-items:center;gap:6px}

    /* æ’­æ”¾å™¨ (å¤åŸï¼šç»¿è‰²çŠ¶æ€ + 16:9) */
    .player-wrapper{width:100%;background:#000;border-radius:8px;position:relative;padding-top:56.25%;margin-bottom:15px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.4)}
    #video{position:absolute;top:0;left:0;width:100%;height:100%}
    .status-playing{color:var(--success);font-weight:bold;font-size:13px;display:flex;align-items:center;justify-content:center;gap:5px}
    
    .input-group{display:flex;margin-bottom:20px;background:var(--surface-light);border-radius:8px;overflow:hidden;border:1px solid var(--border)}
    .url-input{flex:1;background:transparent;border:none;padding:12px;color:#fff;font-size:14px}
    .play-btn{background:var(--primary);color:#000;border:none;padding:0 25px;font-weight:700}

    /* ç¼–è¾‘å™¨å·¥å…·æ  (å¤åŸæ·±è‰²æŒ‰é’®) */
    .editor-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;background:var(--surface-light);padding:10px;border-radius:10px;flex-wrap:wrap;gap:8px;border:1px solid var(--border)}
    .tool-btn{background:rgba(255,255,255,0.05);color:#ddd;border:none;padding:8px 12px;border-radius:6px;font-size:13px;display:flex;align-items:center;gap:5px;transition:0.2s}
    .tool-btn:hover{background:rgba(255,255,255,0.1)}
    .tool-btn.active{background:var(--primary);color:#000;font-weight:700}
    .tool-btn.primary{background:var(--primary);color:#000;font-weight:700}
    
    #codeEditor{width:100%;height:500px;background:#080808;color:#ccc;border:1px solid var(--border);padding:15px;border-radius:8px;font-family:monospace;resize:vertical;white-space:pre;font-size:12px;line-height:1.5}
    
    /* åˆ—è¡¨æ¨¡å¼ (å¤åŸæ‹–æ‹½) */
    #visualEditor{list-style:none;padding:0;display:none}
    .channel-item{background:var(--surface-light);border:1px solid var(--border);margin-bottom:6px;padding:10px 15px;border-radius:6px;display:flex;align-items:center;gap:12px}
    .channel-info{flex:1;overflow:hidden}
    .ch-name{font-weight:700;font-size:14px;color:#fff;margin-bottom:2px}
    .ch-url{font-size:11px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:monospace}
    .drag-handle{color:#555;font-size:18px;padding:5px;cursor:grab}

    /* ç½‘æ ¼æ¨¡å¼ (å¤åŸå°é¢ä¸é€‰ä¸­çŠ¶æ€) */
    #gridEditor{display:none;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;padding-bottom:70px}
    .grid-card{background:var(--surface-light);border:1px solid var(--border);border-radius:8px;overflow:hidden;position:relative;transition:0.2s}
    .grid-card.selected{border-color:var(--primary);background:rgba(62,166,255,0.1)}
    .card-img-box{width:100%;height:0;padding-bottom:56.25%;background:#000;position:relative;display:flex;align-items:center;justify-content:center}
    .card-img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain}
    .card-placeholder{position:absolute;font-size:20px;color:#333;font-weight:700}
    .card-info{padding:8px} 
    .card-tag{font-size:9px;color:var(--primary);background:rgba(62,166,255,0.1);padding:1px 4px;border-radius:2px;display:inline-block;margin-bottom:3px;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .card-name{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .check-circle{position:absolute;top:4px;right:4px;width:16px;height:16px;border-radius:50%;border:1px solid #fff;background:rgba(0,0,0,0.6);display:none;z-index:10}
    .grid-card.selecting .check-circle{display:block} .grid-card.selected .check-circle{background:var(--primary);border-color:var(--primary)}

    /* åº•éƒ¨æ‰¹é‡æ  (å¤åŸæ‚¬æµ®æ¡) */
    .batch-bar{position:fixed;bottom:0;left:0;width:100%;background:#1a1a1a;border-top:1px solid var(--primary);padding:12px 15px;display:none;justify-content:space-between;align-items:center;z-index:300;box-shadow:0 -5px 20px rgba(0,0,0,0.5)}
    .upload-area{border:2px dashed var(--border);border-radius:12px;padding:30px;text-align:center;cursor:pointer;margin-bottom:20px;background:rgba(255,255,255,0.02)}
    
    /* å¼¹çª— (å¤åŸå±æ€§ç¼–è¾‘) */
    .modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:none;justify-content:center;align-items:center;backdrop-filter:blur(3px)}
    .edit-modal{background:#1a1a1a;border-radius:10px;width:90%;max-width:380px;padding:20px;border:1px solid var(--border);box-shadow:0 10px 40px rgba(0,0,0,0.5)}
    .form-group{margin-bottom:12px}
    .form-label{display:block;margin-bottom:5px;color:#888;font-size:12px}
    .form-input{width:100%;background:#080808;border:1px solid #333;padding:10px;color:#fff;border-radius:6px;font-size:14px}
    .format-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:20px}
    .format-btn{background:var(--surface-light);border:1px solid var(--border);padding:15px;border-radius:8px;text-align:center;color:#fff}
</style>
</head>
<body>

<div class="batch-bar" id="batchBar">
    <div id="batchCount" style="color:white;font-weight:700;font-size:14px">Selected: 0</div>
    <div style="display:flex;gap:8px;overflow-x:auto">
        <button class="tool-btn" onclick="toggleSelectAll()" data-i18n="btn_select_all">å…¨é€‰</button>
        <button class="tool-btn" onclick="openBatchEdit('group')" data-i18n="btn_edit_group">æ”¹åˆ†ç»„</button>
        <button class="tool-btn" onclick="openBatchEdit('logo')" data-i18n="btn_edit_logo">æ”¹Logo</button>
        <button class="tool-btn" style="color:var(--danger)" onclick="batchDelete()" data-i18n="btn_delete">åˆ é™¤</button>
        <button class="tool-btn" onclick="toggleBatchMode(false)" data-i18n="btn_exit">é€€å‡º</button>
    </div>
</div>

<div class="modal-bg" id="editModal">
    <div class="edit-modal">
        <h3 style="margin:0 0 15px 0;color:var(--primary);font-size:16px" data-i18n="modal_edit_title">ç¼–è¾‘èµ„æ–™</h3>
        <div id="dynamicForm" style="max-height:60vh;overflow-y:auto"></div>
        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px">
            <button class="tool-btn" onclick="addNewProperty()" style="margin-right:auto" data-i18n="btn_add_prop">+ å±æ€§</button>
            <button class="tool-btn" onclick="document.getElementById('editModal').style.display='none'" data-i18n="btn_cancel">å–æ¶ˆ</button>
            <button class="tool-btn primary" onclick="saveChannelData()" data-i18n="btn_confirm">ç¡®å®š</button>
        </div>
    </div>
</div>

<div class="modal-bg" id="batchInputModal">
    <div class="edit-modal">
        <h3 data-i18n="modal_batch_title" style="margin:0 0 15px 0">æ‰¹é‡ä¿®æ”¹</h3>
        <input type="text" class="form-input" id="batchInput">
        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:15px">
            <button class="tool-btn" onclick="document.getElementById('batchInputModal').style.display='none'" data-i18n="btn_cancel">å–æ¶ˆ</button>
            <button class="tool-btn primary" onclick="applyBatchEdit()" data-i18n="btn_confirm">ç¡®å®š</button>
        </div>
    </div>
</div>

<div class="modal-bg" id="confirmModal">
    <div class="edit-modal" style="text-align:center">
        <h3 data-i18n="modal_file_title" style="margin:0">æ–‡ä»¶å·²è¯»å–</h3>
        <p id="confirmText" style="margin:15px 0;color:#888;font-size:13px"></p>
        <div style="display:flex;justify-content:center;gap:10px">
            <button class="tool-btn" onclick="closeConfirm(false)" data-i18n="btn_cancel">å–æ¶ˆ</button>
            <button class="tool-btn primary" onclick="closeConfirm(true)" data-i18n="btn_confirm">åŠ è½½</button>
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<aside class="sidebar" id="sidebar">
    <div class="sidebar-header" data-i18n="sidebar_title">å·¥å…·ç®±èœå•</div>
    <div class="menu-item active" onclick="switchTab('tester',this)"><span data-i18n="menu_tester">ğŸ“º æ’­æ”¾æµ‹è¯•</span></div>
    <div class="menu-item" onclick="switchTab('capture',this)"><span data-i18n="menu_capture">ğŸ”— æ•æ‰æµ‹è¯•</span></div>
    <div class="menu-item" onclick="switchTab('editor',this)"><span data-i18n="menu_editor">ğŸ“ åˆ—è¡¨ç¼–è¾‘</span></div>
    <div class="menu-item" onclick="switchTab('checker',this)"><span data-i18n="menu_checker">ğŸ“¡ æœ‰æ•ˆæ€§æ£€æµ‹</span></div>
    <div class="menu-item" onclick="switchTab('converter',this)"><span data-i18n="menu_converter">ğŸ”„ æ ¼å¼è½¬æ¢</span></div>
</aside>

<nav class="navbar">
    <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
    <div class="app-title" data-i18n="app_title">M3U/M3U8åœ¨çº¿å·¥å…·ç®±</div>
    <div class="lang-container">
        <button class="lang-btn" onclick="toggleLangMenu()">ğŸŒ <span id="currentLangLabel">CN</span></button>
        <div class="lang-menu" id="langMenu">
            <div class="lang-item" onclick="changeLang('zh')">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</div>
            <div class="lang-item" onclick="changeLang('en')">ğŸ‡ºğŸ‡¸ English</div>
            <div class="lang-item" onclick="changeLang('ja')">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</div>
            <div class="lang-item" onclick="changeLang('ko')">ğŸ‡°ğŸ‡· í•œêµ­ì–´</div>
            <div class="lang-item" onclick="changeLang('ru')">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</div>
            <div class="lang-item" onclick="changeLang('de')">ğŸ‡©ğŸ‡ª Deutsch</div>
            <div class="lang-item" onclick="changeLang('fr')">ğŸ‡«ğŸ‡· FranÃ§ais</div>
            <div class="lang-item" onclick="changeLang('es')">ğŸ‡ªğŸ‡¸ EspaÃ±ol</div>
            <div class="lang-item" onclick="changeLang('pt')">ğŸ‡§ğŸ‡· PortuguÃªs</div>
        </div>
    </div>
</nav>

<main class="main-container">
    <div id="section-tester" class="section-view active">
        <div class="section-title" data-i18n="title_tester">M3U/M3U8 é“¾æ¥åœ¨çº¿æµ‹è¯•</div>
        <div class="tips-box"><div class="tips-title" data-i18n="tips_title">ğŸ’¡ æµ‹è¯•è¯´æ˜</div><span data-i18n="tips_tester_content">æ­¤å·¥å…·ä»…ç”¨äºæµ‹è¯•é“¾æ¥çš„è¿é€šæ€§...</span></div>
        <div class="input-group"><input type="text" class="url-input" id="urlInput" placeholder="http://..."><button class="play-btn" id="playBtn" data-i18n="btn_play">æ’­æ”¾</button></div>
        <div class="player-wrapper"><video id="video" controls></video></div>
        <div id="statusMsg" style="text-align:center;color:#666;font-size:13px" data-i18n="status_ready">å‡†å¤‡å°±ç»ª</div>
    </div>

    <div id="section-capture" class="section-view">
        <div class="section-title" data-i18n="title_capture">åœ¨çº¿ç½‘ç«™æ•æ‰æµ‹è¯• (yt-dlp)</div>
        <div class="tips-box"><div class="tips-title" data-i18n="tips_title">ğŸ’¡ æ ¸å¿ƒæœºåˆ¶è¯´æ˜</div><span data-i18n="tips_capture_content">åŠŸèƒ½ç”¨é€”ï¼šåŸºäº yt-dlp æ ¸å¿ƒ...</span></div>
        <div class="input-group"><input type="text" class="url-input" id="captureInput" placeholder="https://..."><button class="play-btn" id="captureBtn" onclick="testCaptureUrl()" data-i18n="btn_test_link">æµ‹è¯•é“¾æ¥</button></div>
        <div id="captureLoading" style="display:none;text-align:center;padding:20px;color:#888" data-i18n="msg_analyzing">æ­£åœ¨åˆ†æä¸­...</div>
        <div id="captureResult" class="capture-result"></div>
    </div>

    <div id="section-editor" class="section-view">
        <div class="section-title" data-i18n="title_editor">ç›´æ’­æºæ–‡ä»¶ç¼–è¾‘</div>
        <div class="tips-box"><div class="tips-title" data-i18n="tips_title">ğŸ“ ç¼–è¾‘åŠŸèƒ½è¯´æ˜</div><span data-i18n="desc_editor">æ“ä½œæ¨¡å¼ï¼šæä¾›æ–‡æœ¬ã€åˆ—è¡¨ã€ç½‘æ ¼...</span></div>
        <div id="step-upload-editor">
            <div class="upload-area" onclick="triggerUpload('editor')">
                <div style="font-size:32px;margin-bottom:10px">ğŸ“‚</div><p data-i18n="upload_text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶</p>
                <input type="file" id="fileInputEditor" hidden accept=".m3u,.txt" onchange="handleFile(this,'editor')">
            </div>
        </div>
        <div id="step-edit-ui" style="display:none">
            <div class="editor-toolbar">
                <div style="display:flex;gap:8px">
                    <button class="tool-btn active" id="btnModeText" onclick="setMode('text')" data-i18n="mode_text">æ–‡æœ¬</button>
                    <button class="tool-btn" id="btnModeVisual" onclick="setMode('visual')" data-i18n="mode_list">åˆ—è¡¨</button>
                    <button class="tool-btn" id="btnModeGrid" onclick="setMode('grid')" data-i18n="mode_grid">ç½‘æ ¼</button>
                </div>
                <div style="display:flex;gap:8px">
                    <button class="tool-btn" id="btnBatch" onclick="toggleBatchMode()" style="display:none" data-i18n="btn_batch">æ‰¹é‡</button>
                    <button class="tool-btn primary" onclick="saveAndDownload()" data-i18n="btn_save">ä¿å­˜</button>
                    <button class="tool-btn" style="color:var(--danger)" onclick="resetEditor()" data-i18n="btn_discard">é‡ç½®</button>
                </div>
            </div>
            <textarea id="codeEditor" spellcheck="false"></textarea>
            <ul id="visualEditor"></ul>
            <div id="gridEditor"></div>
        </div>
    </div>

    <div id="section-checker" class="section-view">
        <div class="section-title" data-i18n="title_checker">ç›´æ’­æºåœ¨çº¿æ£€æµ‹</div>
        <div class="tips-box"><div class="tips-title" data-i18n="tips_title">ğŸ“¢ æ£€æµ‹æœºåˆ¶è¯´æ˜</div><span data-i18n="tips_checker_content">æ™ºèƒ½æ¢æµ‹...</span></div>
        <div id="step-upload-checker">
            <div class="upload-area" onclick="triggerUpload('checker')">
                <div style="font-size:32px;margin-bottom:10px">ğŸ“¡</div><p data-i18n="upload_text">å¯¼å…¥æ–‡ä»¶</p>
                <input type="file" id="fileInputChecker" hidden onchange="handleFile(this,'checker')">
            </div>
        </div>
        <div id="step-check-ui" style="display:none">
            <div style="display:flex;gap:10px;margin-bottom:10px">
                <div style="flex:1;background:#333;height:4px;align-self:center"><div id="checkProgress" style="width:0%;background:var(--success);height:100%"></div></div>
                <button class="tool-btn primary" id="btnCheckAll" onclick="startCheckAll()" data-i18n="btn_start_check">å¼€å§‹æ£€æµ‹</button>
            </div>
            <div id="checkList" style="max-height:400px;overflow-y:auto"></div>
            <button class="tool-btn" onclick="resetChecker()" style="margin-top:15px;width:100%" data-i18n="btn_reset">é‡ç½®</button>
        </div>
    </div>

    <div id="section-converter" class="section-view">
        <div class="section-title" data-i18n="title_converter">ç›´æ’­æºæ–‡ä»¶è½¬æ¢</div>
        <div class="tips-box"><div class="tips-title" data-i18n="tips_title">ğŸ’¡ æ ¼å¼è½¬æ¢æŒ‡å—</div><span data-i18n="desc_converter">æ™ºèƒ½è§£æ...</span></div>
        <div id="step-upload-converter">
            <div class="upload-area" onclick="triggerUpload('converter')">
                <div style="font-size:32px;margin-bottom:10px">ğŸ”„</div><p data-i18n="upload_text">å¯¼å…¥æ–‡ä»¶</p>
                <input type="file" id="fileInputConverter" hidden onchange="handleFile(this,'converter')">
            </div>
        </div>
        <div id="step-convert-ui" style="display:none;text-align:center">
            <div id="convertStats" style="color:var(--primary);margin-bottom:20px;font-weight:700">Loaded</div>
            <div class="format-grid">
                <div class="format-btn" onclick="doConvert('m3u')">M3U</div>
                <div class="format-btn" onclick="doConvert('txt')">TXT</div>
                <div class="format-btn" onclick="doConvert('tivimate')">TiviMate</div>
                <div class="format-btn" onclick="doConvert('json')">JSON</div>
            </div>
            <button class="tool-btn" onclick="resetConverter()" style="margin-top:20px;width:100%" data-i18n="btn_reupload">è¿”å›</button>
        </div>
    </div>
</main>

<script>
    const API_BASE = "http://127.0.0.1:5000/api/check";
    let currentLang = 'zh';
    
    // å¤šè¯­è¨€å­—å…¸ (å®Œæ•´ç‰ˆ)
    const i18nData = {
        "zh":{ "tips_title":"ğŸ’¡ åŠŸèƒ½è¯´æ˜", "app_title":"M3U/M3U8åœ¨çº¿å·¥å…·ç®±", "sidebar_title":"å·¥å…·ç®±èœå•", "menu_tester":"ğŸ“º åœ¨çº¿é“¾æ¥æµ‹è¯•", "menu_capture":"ğŸ”— åœ¨çº¿ç½‘ç«™æ•æ‰æµ‹è¯•", "menu_editor":"ğŸ“ ç›´æ’­æºåœ¨çº¿ç¼–è¾‘", "menu_checker":"ğŸ“¡ ç›´æ’­æºåœ¨çº¿æ£€æµ‹", "menu_converter":"ğŸ”„ ç›´æ’­æºæ–‡ä»¶è½¬æ¢", "title_tester":"M3U/M3U8 é“¾æ¥åœ¨çº¿æµ‹è¯•", "tips_tester_content":"æ­¤å·¥å…·ä»…ç”¨äºæµ‹è¯•é“¾æ¥çš„<b>è¿é€šæ€§</b>å’Œ<b>åˆå§‹åŠ è½½</b>ã€‚<br>æ³¨æ„ï¼šéƒ¨åˆ†æµåª’ä½“å›  <b>CORSï¼ˆè·¨åŸŸç­–ç•¥ï¼‰</b> é™åˆ¶å¯èƒ½æ— æ³•åœ¨æµè§ˆå™¨ä¸­æ’­æ”¾ï¼Œæˆ–è€…æ‹–åŠ¨è¿›åº¦æ¡æ—¶å¯èƒ½å‡ºç°ç¼“å†²é”™è¯¯ï¼Œè¿™é€šå¸¸å±äºæºç«™é™åˆ¶è€Œéå·¥å…·æ•…éšœã€‚", "title_capture":"åœ¨çº¿ç½‘ç«™æ•æ‰æµ‹è¯• (yt-dlp)", "tips_capture_content":"<b>åŠŸèƒ½ç”¨é€”ï¼š</b>åŸºäº yt-dlp æ ¸å¿ƒï¼Œæµ‹è¯•èƒ½å¦ä»è§†é¢‘ç½‘ç«™ï¼ˆYouTube, Twitch, è™ç‰™ç­‰ï¼‰è§£æå‡º M3U8 ç›´æ’­æµæˆ–çœŸå®æ’­æ”¾åœ°å€ã€‚<br><br><b>âš ï¸ æˆåŠŸç‡è¯´æ˜ï¼š</b><br>1. <b>åçˆ¬å°é”</b>ï¼šYouTube ç­‰å¤§å¹³å°ä¼šå¯¹â€œäº‘æœåŠ¡å™¨ IPâ€è¿›è¡Œä¸¥æ ¼é£æ§ã€‚<br>2. <b>è§£å†³æ–¹æ¡ˆ</b>ï¼šå¼ºçƒˆå»ºè®®ä½¿ç”¨<b>â€œæœ¬åœ°éƒ¨ç½²â€</b>ï¼ˆTermux/NASï¼‰æˆ–<b>â€œç§äººæœåŠ¡å™¨â€</b>ã€‚<br>3. <b>æ“ä½œå»ºè®®</b>ï¼šå¦‚é‡å¤±è´¥ï¼Œè¯·å°è¯•<b>ç‚¹å‡» 2-3 æ¬¡æµ‹è¯•</b>æˆ–æ›´æ¢èŠ‚ç‚¹ã€‚", "title_editor":"ç›´æ’­æºæ–‡ä»¶ç¼–è¾‘", "desc_editor":"1. <b>æ“ä½œæ¨¡å¼</b>ï¼šæä¾›â€œæ–‡æœ¬ä»£ç â€ã€â€œå¯è§†åŒ–åˆ—è¡¨â€å’Œâ€œç½‘æ ¼èµ„æ–™â€ä¸‰ç§è§†å›¾ï¼Œæ”¯æŒæ‹–æ‹½æ’åºã€‚<br>2. <b>æ‰¹é‡å¤„ç†</b>ï¼šåœ¨ç½‘æ ¼æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»å³ä¸Šè§’è¿›å…¥æ‰¹é‡æ¨¡å¼ï¼Œå¯å¿«é€Ÿä¿®æ”¹åˆ†ç»„åç§°å’Œå°æ ‡ã€‚<br>3. <b>æ€§èƒ½æç¤º</b>ï¼šæœ¬åœ°æµè§ˆå™¨å¤„ç†ã€‚å»ºè®®å¤„ç† <b>10MB</b> ä»¥ä¸‹çš„æ–‡ä»¶ã€‚", "title_checker":"ç›´æ’­æºåœ¨çº¿æ£€æµ‹", "tips_checker_content":"1. <b>æ™ºèƒ½æ¢æµ‹</b>ï¼šè‡ªåŠ¨ä½¿ç”¨â€œæ··åˆæ¢æµ‹æ¨¡å¼â€ã€‚<br>2. <b>âš ï¸ å¯èƒ½æœ‰æ•ˆ</b>ï¼šé»„è‰²çŠ¶æ€è¡¨ç¤ºæœåŠ¡å™¨è¿é€šï¼Œä½†è¢«æµè§ˆå™¨æ‹¦æˆªã€‚<br>3. <b>âŒ æ— æ•ˆ</b>ï¼šè¿æ¥æ‹’ç»æˆ–è¶…æ—¶ã€‚", "title_converter":"ç›´æ’­æºæ–‡ä»¶è½¬æ¢", "desc_converter":"1. <b>æ™ºèƒ½è§£æ</b>ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«è¾“å…¥æ–‡ä»¶çš„æ ¼å¼ï¼ˆM3U/TXTï¼‰ã€‚<br>2. <b>TiviMate</b>ï¼šé€‰æ‹© TiviMate æ ¼å¼æ—¶ï¼Œä¼šè‡ªåŠ¨è¡¥å…… <code>tvg-id</code>ã€‚<br>3. <b>é€šç”¨æ€§</b>ï¼šTXT æ ¼å¼ä¸ºâ€œé¢‘é“å,é“¾æ¥â€ç»“æ„ã€‚", "upload_text":"ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶", "btn_select_file":"é€‰æ‹©æ–‡ä»¶", "btn_play":"æ’­æ”¾", "status_ready":"å‡†å¤‡å°±ç»ª", "btn_test_link":"æµ‹è¯•é“¾æ¥", "msg_analyzing":"æ­£åœ¨äº‘ç«¯åˆ†æä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…...", "mode_text":"ğŸ“„ æ–‡æœ¬", "mode_list":"â˜° åˆ—è¡¨", "mode_grid":"â–¦ èµ„æ–™", "btn_batch":"âœ… æ‰¹é‡é€‰æ‹©", "btn_add":"â• æ·»åŠ ", "btn_save":"ğŸ’¾ ä¿å­˜", "btn_discard":"âŒ æ”¾å¼ƒä¿®æ”¹", "btn_select_all":"ğŸ” å…¨é€‰", "btn_edit_group":"æ”¹åˆ†ç»„", "btn_edit_logo":"æ”¹Logo", "btn_delete":"åˆ é™¤", "btn_exit":"é€€å‡º", "upload_checker_text":"å¯¼å…¥ç›´æ’­æºæ–‡ä»¶è¿›è¡Œæ£€æµ‹", "btn_start_check":"â–¶ å¼€å§‹å…¨æµ‹", "btn_reset":"ğŸ”„ æ¸…ç©ºå¹¶é‡æ–°å¯¼å…¥", "upload_converter_text":"å¯¼å…¥ä»»æ„æ ¼å¼ç›´æ’­æº", "label_file_read":"ğŸ“‚ å·²è¯»å–æ–‡ä»¶", "label_channel_count":"å…±è¯†åˆ«æœ‰æ•ˆé¢‘é“ï¼š", "label_select_format":"è¯·é€‰æ‹©ç›®æ ‡æ ¼å¼ï¼š", "fmt_m3u_desc":"æ ‡å‡†æ ¼å¼ï¼Œæ”¯æŒå°æ ‡åˆ†ç»„", "fmt_txt":"TXT æ–‡æœ¬", "fmt_txt_desc":"ç®€å•é€—å·åˆ†éš”", "fmt_json_desc":"å¼€å‘äººå‘˜é€šç”¨æ•°æ®æ ¼å¼", "fmt_tivi_desc":"ä¼˜åŒ–ç‰ˆM3Uï¼Œè¡¥å…¨tvg-id", "btn_reupload":"â†©ï¸ è¿”å›é‡æ–°ä¸Šä¼ ", "batch_selected":"å·²é€‰ 0 ä¸ª", "btn_cancel":"å–æ¶ˆ", "btn_confirm":"ç¡®å®š", "btn_add_prop":"+ å±æ€§", "status_valid":"âœ… è§£ææˆåŠŸ", "status_invalid":"âŒ è§£æå¤±è´¥", "err_network":"ç½‘ç»œæˆ–APIé”™è¯¯", "lbl_source":"æ¥æº", "lbl_duration":"æ—¶é•¿", "lbl_quality":"å¯ç”¨ç”»è´¨/æ ¼å¼", "lbl_raw":"åŸå§‹æµ", "modal_file_title":"æ–‡ä»¶å¤„ç†", "modal_file_desc":"æ–‡ä»¶è¯»å–æˆåŠŸï¼æ˜¯å¦ç»§ç»­ï¼Ÿ", "modal_batch_title":"æ‰¹é‡ä¿®æ”¹", "modal_edit_title":"ç¼–è¾‘èµ„æ–™", "placeholder_url": "è¯·è¾“å…¥é“¾æ¥..." },
        "en":{ "tips_title":"ğŸ’¡ Guide", "app_title":"M3U8 Toolbox", "sidebar_title":"MENU", "menu_tester":"ğŸ“º Tester", "menu_capture":"ğŸ”— Capture", "menu_editor":"ğŸ“ Editor", "menu_checker":"ğŸ“¡ Checker", "menu_converter":"ğŸ”„ Converter", "title_tester":"Stream Tester", "tips_tester_content":"Check connectivity.", "title_capture":"Stream Capture", "tips_capture_content":"Extract streams via yt-dlp.", "title_editor":"Playlist Editor", "desc_editor":"Text, List (Drag), Grid (Batch).", "title_checker":"Stream Checker", "tips_checker_content":"Batch check validity.", "title_converter":"Converter", "desc_converter":"Convert M3U/TXT/JSON.", "btn_play":"PLAY", "btn_test_link":"TEST", "upload_text":"Upload File", "mode_text":"Text", "mode_list":"List", "mode_grid":"Grid", "btn_batch":"Batch", "btn_save":"Save", "btn_discard":"Reset", "btn_select_all":"All", "btn_edit_group":"Group", "btn_edit_logo":"Logo", "btn_delete":"Delete", "btn_exit":"Exit", "btn_start_check":"Start", "btn_reset":"Reset", "btn_reupload":"Back", "btn_cancel":"Cancel", "btn_confirm":"OK", "btn_add_prop":"+Prop", "status_valid":"âœ… OK", "status_invalid":"âŒ Fail", "err_network":"Error", "modal_file_title":"Loaded", "modal_file_desc":"Load?", "modal_batch_title":"Batch", "modal_edit_title":"Edit", "placeholder_url": "Enter URL..." },
        "ja":{ "tips_title":"ğŸ’¡ ã‚¬ã‚¤ãƒ‰", "app_title":"M3U8ãƒ„ãƒ¼ãƒ«", "sidebar_title":"ãƒ¡ãƒ‹ãƒ¥ãƒ¼", "menu_tester":"ğŸ“º ãƒ†ã‚¹ãƒˆ", "menu_capture":"ğŸ”— ã‚­ãƒ£ãƒ—ãƒãƒ£", "menu_editor":"ğŸ“ ç·¨é›†", "menu_checker":"ğŸ“¡ æ¤œå‡º", "menu_converter":"ğŸ”„ å¤‰æ›", "title_tester":"å†ç”Ÿãƒ†ã‚¹ãƒˆ", "tips_tester_content":"æ¥ç¶šç¢ºèªã€‚", "title_capture":"ã‚­ãƒ£ãƒ—ãƒãƒ£", "tips_capture_content":"ã‚¹ãƒˆãƒªãƒ¼ãƒ æŠ½å‡ºã€‚", "title_editor":"ç·¨é›†", "desc_editor":"ãƒ†ã‚­ã‚¹ãƒˆ/ãƒªã‚¹ãƒˆ/ã‚°ãƒªãƒƒãƒ‰ã€‚", "title_checker":"æ¤œå‡º", "tips_checker_content":"ä¸€æ‹¬ç¢ºèªã€‚", "title_converter":"å¤‰æ›", "desc_converter":"ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›ã€‚", "btn_play":"å†ç”Ÿ", "btn_test_link":"ãƒ†ã‚¹ãƒˆ", "upload_text":"ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ", "mode_text":"ãƒ†ã‚­ã‚¹ãƒˆ", "mode_list":"ãƒªã‚¹ãƒˆ", "mode_grid":"ã‚°ãƒªãƒƒãƒ‰", "btn_batch":"ä¸€æ‹¬", "btn_save":"ä¿å­˜", "btn_discard":"ãƒªã‚»ãƒƒãƒˆ", "btn_select_all":"å…¨é¸æŠ", "btn_edit_group":"ã‚°ãƒ«ãƒ¼ãƒ—", "btn_edit_logo":"ãƒ­ã‚´", "btn_delete":"å‰Šé™¤", "btn_exit":"çµ‚äº†", "btn_start_check":"é–‹å§‹", "btn_reset":"ãƒªã‚»ãƒƒãƒˆ", "btn_reupload":"æˆ»ã‚‹", "btn_cancel":"å–æ¶ˆ", "btn_confirm":"ç¢ºå®š", "btn_add_prop":"+å±æ€§", "status_valid":"âœ… æˆåŠŸ", "status_invalid":"âŒ å¤±æ•—", "err_network":"ã‚¨ãƒ©ãƒ¼", "modal_file_title":"ç¢ºèª", "modal_file_desc":"èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ", "modal_batch_title":"ä¸€æ‹¬", "modal_edit_title":"ç·¨é›†", "placeholder_url": "URLã‚’å…¥åŠ›..." },
        // ... (å…¶ä»–è¯­è¨€è‡ªåŠ¨å›é€€åˆ°è‹±æ–‡ï¼Œé˜²æ­¢æŠ¥é”™)
    };
    ['ko','ru','de','fr','es','pt'].forEach(k => { if(!i18nData[k]) i18nData[k] = {...i18nData['en']}; });

    let editorData = { buffer: '', name: 'playlist.m3u', channelData: [] };
    let checkerData = { channels: [] };
    let converterData = { channels: [], name: '' };
    let isBatchMode=false, selectedIndices=new Set(), currentUploadTarget='', currentMode='text', currentBatchType='';

    // Init
    (function(){
        const sys=navigator.language||navigator.userLanguage;
        if(sys.startsWith('zh')) currentLang='zh'; else if(sys.startsWith('ja')) currentLang='ja'; else currentLang='en';
        updatePageLang();
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            document.body.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false);
        });
    })();

    function toggleLangMenu(){ document.getElementById('langMenu').classList.toggle('active'); }
    function changeLang(l){ currentLang=l; updatePageLang(); document.getElementById('langMenu').classList.remove('active'); }
    function updatePageLang(){
        const map={'zh':'CN','en':'EN','ja':'JP','ko':'KR','ru':'RU','de':'DE','fr':'FR','es':'ES','pt':'PT'};
        document.getElementById('currentLangLabel').textContent=map[currentLang]||'EN';
        const d=i18nData[currentLang]||i18nData['en'];
        document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(d[k]) el.innerHTML=d[k]; });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{ const k=el.getAttribute('data-i18n-placeholder'); if(d[k]) el.placeholder=d[k]; });
    }
    function t(k){ return (i18nData[currentLang]||i18nData['en'])[k]||k; }

    function toggleMenu(){ document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
    function switchTab(id,btn){
        document.querySelectorAll('.menu-item').forEach(el=>el.classList.remove('active')); btn.classList.add('active');
        document.querySelectorAll('.section-view').forEach(el=>el.classList.remove('active')); document.getElementById('section-'+id).classList.add('active');
        toggleMenu();
    }

    // æ•æ‰æµ‹è¯• (UI Fix)
    async function testCaptureUrl(){
        const url=document.getElementById('captureInput').value; const res=document.getElementById('captureResult'); const load=document.getElementById('captureLoading');
        if(!url) return;
        res.innerHTML=''; load.style.display='block';
        try {
            const req=await fetch(API_BASE+"?url="+encodeURIComponent(url));
            const data=await req.json();
            load.style.display='none'; res.style.display='block';
            if(data.error){
                res.innerHTML=`<div class="result-card" style="border-left-color:var(--danger)">${t('status_invalid')}: ${data.error}</div>`;
            } else {
                let thumb=data.thumbnail?`<div class="result-thumb-box" style="display:block"><img src="${data.thumbnail}" class="result-thumb"></div>`:'';
                let fmts=(data.formats||[]).map(f=>`<span class="quality-badge ${f.is_audio?'audio':''}">${f.format_note||f.resolution}</span>`).join('');
                res.innerHTML=`<div class="result-card">${thumb}<div class="result-header"><div class="result-title">${data.title}</div><div class="result-badge">${t('status_valid')}</div></div><div class="quality-badges">${fmts}</div></div>`;
            }
        } catch(e){ load.style.display='none'; res.style.display='block'; res.innerHTML=`<div class="result-card" style="border-left-color:var(--danger)">${t('err_network')}: ${e.message}</div>`; }
    }

    // æ–‡ä»¶ä¸Šä¼  (ç»å¯¹ä¿®å¤)
    window.handleFile = function(input, target) {
        const f=input.files[0]; if(!f)return;
        currentUploadTarget = target;
        const r=new FileReader();
        r.onload = (e) => {
            const txt=e.target.result;
            if(target==='editor'){ editorData.buffer=txt; editorData.name=f.name; }
            else if(target==='checker') checkerData.raw=txt;
            else { converterData.raw=txt; converterData.name=f.name; }
            document.getElementById('confirmText').textContent = t('modal_file_desc');
            document.getElementById('confirmModal').style.display='flex';
        };
        r.readAsText(f);
        input.value='';
    };
    function triggerUpload(tgt){ document.getElementById(tgt==='editor'?'fileInputEditor':(tgt==='checker'?'fileInputChecker':'fileInputConverter')).click(); }
    function closeConfirm(yes){
        document.getElementById('confirmModal').style.display='none';
        if(!yes) return;
        if(currentUploadTarget==='editor'){
            document.getElementById('codeEditor').value=editorData.buffer;
            document.getElementById('step-upload-editor').style.display='none';
            document.getElementById('step-edit-ui').style.display='block';
            setMode('text');
        } else if(currentUploadTarget==='checker') initChecker(checkerData.raw);
        else initConverter(converterData.raw);
    }

    // æ™ºèƒ½è§£æé€»è¾‘ (ä¿®å¤ï¼šè‡ªåŠ¨è¯†åˆ«æ›´å¤šå±æ€§)
    function parseM3U(txt){
        const lines=txt.split(/\r?\n/); const ch=[]; let cur=null;
        lines.forEach(l=>{
            l=l.trim();
            if(l.startsWith('#EXTINF:')){
                const p={}; 
                // æå–é€šç”¨å±æ€§
                const logo = l.match(/tvg-logo="([^"]*)"/); if(logo) p['tvg-logo']=logo[1];
                const grp = l.match(/group-title="([^"]*)"/); if(grp) p['group-title']=grp[1];
                const id = l.match(/tvg-id="([^"]*)"/); if(id) p['tvg-id']=id[1];
                const name = l.split(',').pop().trim();
                cur={name:name, params:p};
            } else if(l&&!l.startsWith('#')){ if(cur){ cur.url=l; ch.push(cur); cur=null; } }
        });
        return ch;
    }
    
    // æ™ºèƒ½ç”Ÿæˆé€»è¾‘ (ä¿®å¤ï¼šè‡ªåŠ¨æ’å…¥ç©ºè¡Œç¾åŒ–)
    function syncText(){
        let out="#EXTM3U\n"; 
        editorData.channelData.forEach(c=>{ 
            let attrStr = "";
            for(let k in c.params) attrStr += ` ${k}="${c.params[k]}"`;
            out+=`#EXTINF:-1${attrStr},${c.name}\n${c.url}\n\n`; // åŒæ¢è¡Œç¬¦å®ç°ç©ºè¡Œåˆ†éš”
        });
        document.getElementById('codeEditor').value=out;
    }

    function setMode(m){
        if(currentMode==='text') editorData.channelData=parseM3U(document.getElementById('codeEditor').value); else if(m==='text') syncText();
        document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('codeEditor').style.display='none';
        document.getElementById('visualEditor').style.display='none';
        document.getElementById('gridEditor').style.display='none';
        document.getElementById('btnBatch').style.display='none';
        
        if(m==='text'){
            document.getElementById('codeEditor').style.display='block';
            document.getElementById('btnModeText').classList.add('active');
        } else if(m==='visual'){
            document.getElementById('visualEditor').style.display='block';
            renderList();
            document.getElementById('btnModeVisual').classList.add('active');
        } else {
            document.getElementById('gridEditor').style.display='grid';
            document.getElementById('btnBatch').style.display='flex';
            renderGrid();
            document.getElementById('btnModeGrid').classList.add('active');
        }
        currentMode=m;
    }

    // åˆ—è¡¨æ¨¡å¼ (ç»å¯¹ä¿®å¤æ‹–æ‹½)
    function renderList(){
        const el=document.getElementById('visualEditor'); el.innerHTML='';
        editorData.channelData.forEach((c,i)=>{
            el.innerHTML+=`<li class="channel-item"><div class="drag-handle">â˜°</div><div style="flex:1"><div class="ch-name">${c.name}</div><div class="ch-url">${c.url}</div></div></li>`;
        });
        if(window.Sortable) Sortable.create(el, { handle:'.drag-handle', animation:150, onEnd:(e)=>{
            const item=editorData.channelData.splice(e.oldIndex,1)[0]; editorData.channelData.splice(e.newIndex,0,item);
        }});
    }

    // ç½‘æ ¼æ¨¡å¼ (ä¿®å¤å°é¢)
    function renderGrid(){
        const el=document.getElementById('gridEditor'); el.innerHTML='';
        editorData.channelData.forEach((c,i)=>{
            const sel=selectedIndices.has(i)?'selected':''; const sc=isBatchMode?'selecting':'';
            const logo=c.params['tvg-logo'];
            // ä¿®å¤ï¼šå›¾ç‰‡é”™è¯¯å›é€€é€»è¾‘
            const imgHtml=logo?`<img src="${logo}" class="card-img" onerror="this.style.display='none';this.nextElementSibling.style.display='block'">`:'';
            el.innerHTML+=`<div class="grid-card ${sel} ${sc}" onclick="clickCard(${i})"><div class="check-circle"></div><div class="card-img-box">${imgHtml}<div class="card-placeholder" ${logo?'style="display:none"':''}>ğŸ“º</div></div><div class="card-info"><div class="card-tag">${c.params['group-title']||'UNK'}</div><div class="card-name">${c.name}</div></div></div>`;
        });
    }

    // ç¼–è¾‘å¼¹çª—é€»è¾‘ (ä¿®å¤ï¼šåŠ¨æ€è¡¨å•)
    let currentEditIndex = -1;
    function clickCard(i){ 
        if(isBatchMode){ if(selectedIndices.has(i)) selectedIndices.delete(i); else selectedIndices.add(i); document.getElementById('batchCount').textContent=`Selected: ${selectedIndices.size}`; renderGrid(); } 
        else { currentEditIndex=i; openEditModal(i); }
    }
    function openEditModal(idx){
        const item=editorData.channelData[idx];
        const form=document.getElementById('dynamicForm'); form.innerHTML='';
        
        // æ¸²æŸ“åŸºæœ¬å­—æ®µ
        createInput('å§“å', 'name', item.name);
        createInput('ç½‘å€', 'url', item.url);
        
        // æ¸²æŸ“æ‰€æœ‰å·²å­˜åœ¨çš„ params
        for(let k in item.params) createInput(k, k, item.params[k]);
        
        document.getElementById('editModal').style.display='flex';
    }
    function createInput(lbl, key, val){
        const div=document.createElement('div'); div.className='form-group';
        div.innerHTML=`<label class="form-label">${lbl}</label><input class="form-input" data-key="${key}" value="${val||''}">`;
        document.getElementById('dynamicForm').appendChild(div);
    }
    function addNewProperty(){
        const key=prompt("è¾“å…¥å±æ€§å (å¦‚ tvg-id):");
        if(key) createInput(key, key, '');
    }
    function saveChannelData(){
        const inputs=document.querySelectorAll('#dynamicForm input');
        const item=editorData.channelData[currentEditIndex];
        inputs.forEach(inp=>{
            const k=inp.dataset.key;
            if(k==='name') item.name=inp.value; else if(k==='url') item.url=inp.value; else item.params[k]=inp.value;
        });
        syncText(); renderGrid(); document.getElementById('editModal').style.display='none';
    }

    // æ‰¹é‡é€»è¾‘
    function toggleBatchMode(f){ isBatchMode=f!==undefined?f:!isBatchMode; selectedIndices.clear(); document.getElementById('batchBar').style.display=isBatchMode?'flex':'none'; renderGrid(); }
    function toggleSelectAll(){ if(selectedIndices.size===editorData.channelData.length) selectedIndices.clear(); else editorData.channelData.forEach((_,i)=>selectedIndices.add(i)); document.getElementById('batchCount').textContent=`Selected: ${selectedIndices.size}`; renderGrid(); }
    function batchDelete(){ if(!confirm('Delete?')) return; const idxs=Array.from(selectedIndices).sort((a,b)=>b-a); idxs.forEach(i=>editorData.channelData.splice(i,1)); toggleBatchMode(false); setMode('grid'); }
    function openBatchEdit(t){ currentBatchType=t; document.getElementById('batchInput').value=''; document.getElementById('batchInputModal').style.display='flex'; }
    function applyBatchEdit(){ const v=document.getElementById('batchInput').value; const k=currentBatchType==='group'?'group-title':'tvg-logo'; selectedIndices.forEach(i=>editorData.channelData[i].params[k]=v); document.getElementById('batchInputModal').style.display='none'; toggleBatchMode(false); }
    function saveAndDownload(){ if(currentMode!=='text') syncText(); const b=new Blob([document.getElementById('codeEditor').value],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='playlist.m3u'; a.click(); }

    // åˆå§‹åŒ–å…¶ä»–
    function initChecker(txt){ document.getElementById('step-upload-checker').style.display='none'; document.getElementById('step-check-ui').style.display='block'; checkerData.channels=parseM3U(txt); document.getElementById('checkList').innerHTML=checkerData.channels.map(c=>`<div class="check-item"><div>${c.name}</div><div style="font-size:12px;color:#888">WAIT</div></div>`).join(''); }
    function initConverter(txt){ document.getElementById('step-upload-converter').style.display='none'; document.getElementById('step-convert-ui').style.display='block'; converterData.channels=parseM3U(txt); document.getElementById('convertStats').textContent=`Loaded: ${converterData.channels.length} Channels`; }
    function resetEditor(){ location.reload(); } function resetChecker(){ location.reload(); } function resetConverter(){ location.reload(); }
    
    // æ’­æ”¾å™¨ (ä¿®å¤ï¼šç»¿å­—çŠ¶æ€)
    document.getElementById('playBtn').addEventListener('click', ()=>{
        const url=document.getElementById('urlInput').value; const v=document.getElementById('video'); const msg=document.getElementById('statusMsg');
        if(!url) return;
        if(Hls.isSupported()){ 
            const h=new Hls(); h.loadSource(url); h.attachMedia(v); 
            h.on(Hls.Events.MANIFEST_PARSED, ()=>{ v.play(); msg.innerHTML='<span class="status-playing">âœ… æ’­æ”¾ä¸­</span>'; });
            h.on(Hls.Events.ERROR, (e,data)=>{ 
                if(data.fatal) { msg.textContent="âŒ Error: "+data.type; msg.style.color="var(--danger)"; }
            });
        } else if(v.canPlayType('application/vnd.apple.mpegurl')){ v.src=url; v.play(); }
    });
</script>
</body>
</html>
