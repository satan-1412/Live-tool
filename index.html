<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OSB PLAYER | SYSTEM</title>
    <meta name="referrer" content="no-referrer">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;600&family=Noto+Sans+SC:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ================== æ ¸å¿ƒè§†è§‰ V3.1 ================== */
        :root {
            /* é»˜è®¤æ¨¡å¼ */
            --bg-color: #0a0a0a;
            --bg-image: none;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-main: #f0f0f0;
            --text-sub: #888;
            --accent: #00ff88;
            --border: rgba(255, 255, 255, 0.1);
            --blur: 10px;
            --font-main: 'Noto Sans SC', sans-serif;
            --font-display: 'Exo 2', sans-serif;
        }

        /* Root æ¨¡å¼ */
        body.root-mode {
            --bg-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop'); 
            --bg-color: #1a0510;
            --card-bg: rgba(40, 0, 20, 0.6);
            --text-main: #xffddee;
            --text-sub: #ff99cc;
            --accent: #ff0077;
            --border: rgba(255, 0, 119, 0.3);
            --blur: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            background-image: var(--bg-image);
            background-size: cover; background-position: center; background-attachment: fixed;
            color: var(--text-main); font-family: var(--font-main);
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; transition: all 0.6s ease;
        }

        body::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.9));
            z-index: -1; pointer-events: none;
        }

        /* å¤´éƒ¨ */
        header {
            padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(var(--blur));
            border-bottom: 1px solid var(--border); z-index: 50;
        }

        .logo {
            font-family: var(--font-display); font-size: 22px; font-weight: 700;
            color: var(--accent); letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(0,0,0,0.5); cursor: pointer; user-select: none;
        }
        
        .search-container { position: relative; width: 40%; max-width: 300px; }
        .search-input {
            width: 100%; background: rgba(255,255,255,0.1); border: 1px solid var(--border);
            border-radius: 50px; padding: 8px 15px 8px 35px; color: #fff; outline: none;
            font-size: 14px; transition: 0.3s;
        }
        .search-input:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 12px; }

        /* å†…å®¹åŒº */
        #main-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* é”™è¯¯æ—¥å¿—é¢æ¿ (å¹³æ—¶éšè—ï¼Œå‡ºé”™æ˜¾ç¤º) */
        #error-log {
            display: none; padding: 10px; background: rgba(255,0,0,0.2); 
            border-bottom: 1px solid red; color: #ff9999; font-size: 12px; font-family: monospace;
            white-space: pre-wrap; word-break: break-all;
        }

        #nav-scroll {
            padding: 10px 15px; display: flex; gap: 15px; overflow-x: auto;
            border-bottom: 1px solid var(--border); scrollbar-width: none;
        }
        #nav-scroll::-webkit-scrollbar { display: none; }
        
        .nav-btn {
            background: transparent; border: none; color: var(--text-sub);
            font-size: 15px; font-weight: 500; white-space: nowrap; cursor: pointer;
            padding: 5px 10px; border-radius: 20px; transition: 0.3s;
        }
        .nav-btn.active { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--accent); }

        /* å®«æ ¼å¸ƒå±€ */
        #channel-grid {
            flex: 1; padding: 20px; overflow-y: auto;
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px; align-content: start;
        }
        @media (max-width: 768px) {
            #channel-grid { padding: 15px; gap: 15px; grid-template-columns: repeat(2, 1fr); }
            .logo { font-size: 18px; }
            .search-container { width: 50%; }
        }

        .card {
            background: var(--card-bg); border-radius: 12px; overflow: hidden;
            border: 1px solid var(--border); cursor: pointer; aspect-ratio: 16/10;
            display: flex; flex-direction: column; position: relative;
            transition: transform 0.2s; backdrop-filter: blur(5px);
        }
        .card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .card-img-box { flex: 1; background: #000; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center;}
        .card-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: 0.5s; position: absolute; top:0; left:0;}
        .card:hover .card-img { opacity: 1; transform: scale(1.1); }
        .card-placeholder { font-family: var(--font-display); font-size: 20px; color: rgba(255,255,255,0.2); }
        .card-title { padding: 10px; font-size: 13px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; background: rgba(0,0,0,0.3); }

        /* æ’­æ”¾å™¨ */
        #player-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: none; flex-direction: column;
        }
        #player-modal.active { display: flex; }

        #video-container { position: relative; width: 100%; flex: 1; background: #000; display: flex; align-items: center; justify-content: center; }
        /* é”®ç›˜é¡¶èµ·é€»è¾‘ */
        body.keyboard-active #video-container { flex: 0 0 40vh; }

        video { width: 100%; height: 100%; max-height: 100%; }
        #danmaku-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }

        .player-top { position: absolute; top: 0; left: 0; width: 100%; height: 60px; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); z-index: 30; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .close-btn { color: #fff; font-size: 24px; cursor: pointer; }
        .live-status { display: flex; align-items: center; gap: 6px; background: rgba(255,0,0,0.2); border: 1px solid rgba(255,0,0,0.6); padding: 4px 10px; border-radius: 4px; color: #ff3333; font-weight: bold; font-size: 12px; }
        .live-dot { width: 8px; height: 8px; background: red; border-radius: 50%; animation: blink 1s infinite; box-shadow: 0 0 5px red; }

        .player-bottom { width: 100%; padding: 10px 15px; background: #111; border-top: 1px solid #333; display: flex; gap: 10px; align-items: center; z-index: 40; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .dm-input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 10px 15px; border-radius: 20px; outline: none; font-size: 14px; }
        .dm-input:focus { border-color: var(--accent); background: #000; }
        .action-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #ddd; font-size: 18px; cursor: pointer; }
        .send-btn { color: var(--accent); }

        @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.3} }
        @keyframes pulse-color { 0% {color: var(--accent);} 50% {color: #fff; text-shadow:0 0 15px var(--accent);} 100% {color: var(--accent);} }
        .triggering { animation: pulse-color 0.5s infinite; }
        
        /* Loading çŠ¶æ€ */
        .loading-state { grid-column: 1/-1; text-align: center; padding: 50px; color: #666; font-size: 14px; }
    </style>
</head>
<body>

<header>
    <div class="logo" id="osb-logo">OSB <span style="font-size:12px;opacity:0.6">PRO</span></div>
    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" id="search-box" placeholder="æœç´¢é¢‘é“...">
    </div>
</header>

<div id="main-container">
    <div id="error-log"></div> <div id="nav-scroll"></div>
    <div id="channel-grid">
        <div class="loading-state"><i class="fas fa-circle-notch fa-spin"></i> SYSTEM INITIALIZING...</div>
    </div>
</div>

<div id="player-modal">
    <div id="video-container">
        <video id="video-player" playsinline webkit-playsinline></video>
        <canvas id="danmaku-layer"></canvas>
        <div class="player-top">
            <div class="close-btn" onclick="closePlayer()"><i class="fas fa-chevron-down"></i></div>
            <div class="live-status"><div class="live-dot"></div> LIVE</div>
        </div>
    </div>
    <div class="player-bottom">
        <div class="action-btn" onclick="toggleDanmaku()"><i class="fas fa-comment-slash" id="dm-icon"></i></div>
        <input type="text" class="dm-input" id="dm-input" placeholder="å‘é€å¼¹å¹•..." autocomplete="off">
        <div class="action-btn send-btn" onclick="sendDanmaku()"><i class="fas fa-paper-plane"></i></div>
        <div class="action-btn" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></div>
    </div>
</div>

<script>
    // ================= ğŸ›¡ï¸ å…¨å±€å¼‚å¸¸æ•è· (æœ€ä¼˜å…ˆè¿è¡Œ) =================
    window.onerror = function(msg, url, line, col, error) {
        const log = document.getElementById('error-log');
        log.style.display = 'block';
        log.innerHTML += `[ERROR] ${msg} (Line:${line})\n`;
        return false;
    };

    // ================= ğŸ”§ é…ç½®ä¸­å¿ƒ =================
    const CONFIG = {
        // æ­£å¸¸æº
        safeUrl: 'https://raw.githubusercontent.com/satan-1412/live/refs/heads/main/no%20sex/TV_1(no%20sex).m3u8',
        
        // æˆäººæº (æ··æ·†åŠ å¯†) - æ£€æŸ¥è¿™é‡Œæ˜¯å¦å¤åˆ¶å®Œæ•´
        _secret: "ODN1bS5WVC9uaWFtL2V2aWwvMjE0MS1uYXRhcy9tb2MudG5ldG5vY3Jlc3VidWh0aWcud2FyLy86c3B0dGg=",
        
        triggerTime: 10000 
    };

    // çŠ¶æ€ç®¡ç†
    let app = {
        mode: 'SAFE',
        data: [],
        cat: 'ALL',
        hls: null
    };

    // ================= ğŸš€ åˆå§‹åŒ–é€»è¾‘ =================
    
    // ç¡®ä¿ Logo ç›‘å¬ç‹¬ç«‹äºç½‘ç»œè¯·æ±‚ï¼Œå“ªæ€•æ²¡ç½‘ä¹Ÿèƒ½è§¦å‘
    function initLogoTrigger() {
        const logo = document.getElementById('osb-logo');
        let timer = null;
        
        const start = (e) => {
            // e.preventDefault(); // å¦‚æœ‰ç‚¹å‡»å†²çªå¯å¼€å¯
            logo.classList.add('triggering');
            timer = setTimeout(toggleMode, CONFIG.triggerTime);
        };
        const end = () => {
            clearTimeout(timer);
            logo.classList.remove('triggering');
        };

        ['mousedown', 'touchstart'].forEach(evt => logo.addEventListener(evt, start));
        ['mouseup', 'mouseleave', 'touchend'].forEach(evt => logo.addEventListener(evt, end));
        console.log("Logo trigger initialized");
    }

    window.onload = () => {
        try {
            initLogoTrigger(); // ä¼˜å…ˆåŠ è½½å½©è›‹
            initDanmaku();
            initKeyboardFix();
            loadSource(CONFIG.safeUrl); // æœ€ååŠ è½½ç½‘ç»œæ•°æ®
        } catch (e) {
            alert("åˆå§‹åŒ–å¤±è´¥: " + e.message);
        }
    };

    // ================= ğŸ“¡ æ•°æ®å±‚ =================
    
    function getSecretUrl() {
        try {
            return atob(CONFIG._secret).split('').reverse().join('');
        } catch(e) { 
            console.error("è§£å¯†å¤±è´¥", e);
            return ''; 
        }
    }

    function loadSource(url) {
        const grid = document.getElementById('channel-grid');
        grid.innerHTML = '<div class="loading-state"><i class="fas fa-sync fa-spin"></i> UPDATING DATABASE...</div>';
        
        // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
        const noCacheUrl = url + '?t=' + new Date().getTime();

        fetch(noCacheUrl)
            .then(response => {
                if (!response.ok) throw new Error("HTTP " + response.status);
                return response.text();
            })
            .then(text => {
                if (!text || text.length < 10) throw new Error("ç©ºæ•°æ®æˆ–æ— æ•ˆæ–‡ä»¶");
                parseM3U8(text);
            })
            .catch(err => {
                grid.innerHTML = `<div class="loading-state" style="color:red">
                    <i class="fas fa-exclamation-triangle"></i> è¿æ¥å¤±è´¥<br>
                    <small>${err.message}</small><br>
                    <small>è¯·æ£€æŸ¥ç½‘ç»œæˆ– CORS è®¾ç½®</small>
                </div>`;
            });
    }

    function parseM3U8(content) {
        app.data = [];
        const lines = content.split('\n');
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.startsWith('#EXTINF')) {
                const title = line.split(',')[1] || 'æœªçŸ¥é¢‘é“';
                const logo = (line.match(/tvg-logo="([^"]+)"/) || [])[1] || '';
                const group = (line.match(/group-title="([^"]+)"/) || [])[1] || 'å…¶å®ƒ';
                const url = lines[i+1] ? lines[i+1].trim() : '';
                
                if (url && url.startsWith('http')) {
                    app.data.push({ title, logo, group, url });
                }
            }
        }
        
        if (app.data.length === 0) {
            document.getElementById('channel-grid').innerHTML = '<div class="loading-state">æœªæ‰¾åˆ°æœ‰æ•ˆé¢‘é“</div>';
        } else {
            renderNav();
            renderGrid();
        }
    }

    // ================= ğŸ¨ æ¸²æŸ“å±‚ =================
    function renderNav() {
        const groups = new Set(['ALL']);
        app.data.forEach(d => groups.add(d.group));
        
        const nav = document.getElementById('nav-scroll');
        nav.innerHTML = '';
        groups.forEach(g => {
            const btn = document.createElement('button');
            btn.className = `nav-btn ${g === app.cat ? 'active' : ''}`;
            btn.innerText = g;
            btn.onclick = () => { app.cat = g; renderNav(); renderGrid(); };
            nav.appendChild(btn);
        });
    }

    function renderGrid() {
        const grid = document.getElementById('channel-grid');
        grid.innerHTML = '';
        const keyword = document.getElementById('search-box').value.toLowerCase();
        
        const list = app.data.filter(d => {
            if (app.cat !== 'ALL' && d.group !== app.cat) return false;
            if (keyword && !d.title.toLowerCase().includes(keyword)) return false;
            return true;
        });

        if (list.length === 0) {
            grid.innerHTML = '<div class="loading-state">æ— æœç´¢ç»“æœ</div>';
            return;
        }

        list.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = () => playVideo(item.url);
            
            let imgHTML = `<div class="card-placeholder">OSB</div>`;
            if (item.logo) imgHTML = `<img src="${item.logo}" class="card-img" onerror="this.style.opacity=0">`;

            card.innerHTML = `
                <div class="card-img-box">${imgHTML}</div>
                <div class="card-title">${item.title}</div>
            `;
            grid.appendChild(card);
        });
    }
    
    document.getElementById('search-box').addEventListener('input', renderGrid);

    // ================= ğŸ¬ æ’­æ”¾æ§åˆ¶ =================
    const modal = document.getElementById('player-modal');
    const video = document.getElementById('video-player');

    function playVideo(url) {
        modal.classList.add('active');
        if (Hls.isSupported()) {
            if (app.hls) app.hls.destroy();
            app.hls = new Hls();
            app.hls.loadSource(url);
            app.hls.attachMedia(video);
            app.hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.play();
        }
        startDmLoop();
    }

    function closePlayer() {
        modal.classList.remove('active');
        video.pause();
        if (app.hls) app.hls.destroy();
        stopDmLoop();
    }

    function toggleFullScreen() {
        const el = document.getElementById('video-container');
        if (!document.fullscreenElement) el.requestFullscreen().catch(()=>{});
        else document.exitFullscreen();
    }

    function initKeyboardFix() {
        const input = document.getElementById('dm-input');
        input.addEventListener('focus', () => {
            document.body.classList.add('keyboard-active');
            setTimeout(() => input.scrollIntoView({behavior:"smooth"}), 300);
        });
        input.addEventListener('blur', () => document.body.classList.remove('keyboard-active'));
    }

    // ================= ğŸš€ å¼¹å¹•é€»è¾‘ (ä¼˜åŒ–ç‰ˆ) =================
    const canvas = document.getElementById('danmaku-layer');
    const ctx = canvas.getContext('2d');
    let dms = []; 
    let dmRaf = null;
    let showDm = true;

    function initDanmaku() {
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    }
    function resizeCanvas() {
        canvas.width = canvas.parentElement.offsetWidth;
        canvas.height = canvas.parentElement.offsetHeight;
        ctx.font = "bold 20px 'Noto Sans SC'";
    }

    function sendDanmaku() {
        const input = document.getElementById('dm-input');
        const txt = input.value.trim();
        if (!txt) return;
        
        dms.push({
            text: txt,
            x: canvas.width,
            y: 40 + Math.random() * (canvas.height * 0.4),
            speed: 2 + Math.random(),
            color: '#00ff88',
            isSelf: true
        });
        input.value = '';
        input.focus();
    }
    
    document.getElementById('dm-input').addEventListener('keypress', e => {
        if(e.key === 'Enter') sendDanmaku();
    });

    function toggleDanmaku() {
        showDm = !showDm;
        canvas.style.opacity = showDm ? 1 : 0;
        document.getElementById('dm-icon').className = showDm ? 'fas fa-comment-dots' : 'fas fa-comment-slash';
    }

    function startDmLoop() { if(!dmRaf) loop(); }
    function stopDmLoop() { cancelAnimationFrame(dmRaf); dmRaf = null; dms = []; ctx.clearRect(0,0,canvas.width,canvas.height); }

    function loop() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if (showDm) {
            for (let i=0; i<dms.length; i++) {
                let d = dms[i];
                d.x -= d.speed;
                ctx.fillStyle = d.color || '#fff';
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.strokeText(d.text, d.x, d.y);
                ctx.fillText(d.text, d.x, d.y);
                if (d.x < -ctx.measureText(d.text).width) {
                    dms.splice(i, 1); i--;
                }
            }
        }
        dmRaf = requestAnimationFrame(loop);
    }

    // ================= ğŸ¥š æ¨¡å¼åˆ‡æ¢ =================
    function toggleMode() {
        if (app.mode === 'SAFE') {
            app.mode = 'ROOT';
            document.body.classList.add('root-mode');
            alert("âœ… ACCESS GRANTED");
            loadSource(getSecretUrl());
        } else {
            app.mode = 'SAFE';
            document.body.classList.remove('root-mode');
            alert("ğŸ›¡ï¸ SYSTEM RESTORED");
            loadSource(CONFIG.safeUrl);
        }
        if (navigator.vibrate) navigator.vibrate(200);
    }
</script>
</body>
</html>
