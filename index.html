<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OSB PLAYER | PRO</title>
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg: #0a0a0a; --surface: #1a1a1a; --primary: #00ff88; --text: #fff; }
        body.root-mode { --bg: #1a0510; --surface: #2d0a1a; --primary: #ff0055; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; overflow: hidden; }

        /* 页面切换逻辑 */
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); background: var(--bg); }
        #page-lobby { z-index: 10; }
        #page-player { z-index: 20; transform: translateX(100%); }
        body.player-active #page-player { transform: translateX(0); }

        /* 大厅 UI */
        header { padding: 15px; background: #111; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #333; }
        .logo { font-size: 22px; font-weight: 900; color: var(--primary); cursor: pointer; user-select: none; }
        .logo.triggering { text-shadow: 0 0 15px var(--primary); color: #fff; }
        .search-input { flex: 1; background: #222; border: none; border-radius: 6px; padding: 10px; color: #fff; outline: none; }
        #lobby-grid { flex: 1; padding: 15px; overflow-y: auto; display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; align-content: start; }
        .card { background: var(--surface); border-radius: 8px; overflow: hidden; }
        .card-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; background: #000; display: block; }
        .card-name { padding: 8px; font-size: 13px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 播放器 UI */
        #video-wrap { width: 100%; height: 35vh; background: #000; position: relative; flex-shrink: 0; }
        video { width: 100%; height: 100%; object-fit: contain; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .p-header { position: absolute; top: 0; left: 0; width: 100%; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(rgba(0,0,0,0.8), transparent); z-index: 15; }
        .p-back { font-size: 20px; color: #fff; padding: 5px; cursor: pointer; }
        .live-tag { background: #ff0000; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 3px; font-weight: bold; display: none; align-items: center; gap: 4px; }
        .live-dot { width: 6px; height: 6px; background: #fff; border-radius: 50%; animation: blink 1s infinite; }

        /* 详情与选台 */
        #detail-wrap { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .ch-info { padding: 15px; background: var(--surface); display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #333; }
        .ch-logo { width: 50px; height: 30px; object-fit: contain; background: #000; border-radius: 4px; }
        .ch-meta h3 { margin: 0; font-size: 16px; }
        .ch-meta p { margin: 3px 0 0; font-size: 12px; color: var(--text-gray); }
        .playlist { flex: 1; overflow-y: auto; padding: 10px; }
        .play-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #222; font-size: 14px; }
        .play-item.active { color: var(--primary); border-left: 3px solid var(--primary); background: rgba(255,255,255,0.05); }

        /* 弹幕输入 */
        .dm-bar { padding: 10px 15px; background: #1a1a1a; display: flex; gap: 10px; align-items: center; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .dm-input { flex: 1; background: #333; border: none; border-radius: 20px; padding: 10px 15px; color: #fff; outline: none; }
        .dm-send { width: 40px; height: 40px; border-radius: 50%; background: var(--primary); color: #000; display: flex; align-items: center; justify-content: center; }

        @keyframes blink { 50% { opacity: 0; } }
        @keyframes pulse { 50% { text-shadow: 0 0 15px var(--primary); color: #fff; } }
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.9); color: #fff; padding: 12px 20px; border-radius: 8px; display: none; z-index: 1000; }
    </style>
</head>
<body>

<div id="page-lobby" class="page">
    <header>
        <div class="logo" id="logo-trigger">OSB</div>
        <input type="text" class="search-input" id="search" placeholder="搜索频道...">
    </header>
    <div id="lobby-grid"><div style="text-align:center;width:100%;padding:50px;">加载中...</div></div>
</div>

<div id="page-player" class="page">
    <div id="video-wrap">
        <video id="video" playsinline webkit-playsinline controls></video>
        <canvas id="dm-canvas"></canvas>
        <div class="p-header">
            <div class="p-back" onclick="closePlayer()"><i class="fas fa-chevron-left"></i></div>
            <div class="live-tag" id="live-tag"><div class="live-dot"></div> LIVE</div>
            <div onclick="toggleFS()" style="color:#fff;padding:5px;"><i class="fas fa-expand"></i></div>
        </div>
    </div>

    <div id="detail-wrap">
        <div class="ch-info">
            <img id="ch-logo" class="ch-logo">
            <div class="ch-meta">
                <h3 id="ch-title">--</h3>
                <p id="ch-remark">线路: HLS | 信号: 自动</p>
            </div>
        </div>
        <div class="playlist" id="playlist"></div>
        <div class="dm-bar">
            <input type="text" class="dm-input" id="dm-input" placeholder="全网同步弹幕...">
            <div class="dm-send" onclick="sendDm()"><i class="fas fa-paper-plane"></i></div>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    const CONFIG = {
        safeUrl: 'https://raw.githubusercontent.com/satan-1412/live/refs/heads/main/no%20sex/TV_1(no%20sex).m3u8',
        rootUrl: 'https://raw.githubusercontent.com/satan-1412/live/main/TV.m3u8',
        mqttBroker: 'wss://broker.emqx.io:8084/mqtt'
    };

    let app = { mode: 'SAFE', data: [], currentCh: null, mqtt: null, topic: null };

    // 初始化
    window.onload = () => {
        initLogo();
        initMQTT();
        initCanvas();
        loadData(CONFIG.safeUrl);
    };

    function loadData(url) {
        fetch(url + '?t=' + Date.now()).then(r => r.text()).then(txt => parseM3U8(txt));
    }

    function parseM3U8(txt) {
        app.data = [];
        txt.split('\n').forEach((line, i, arr) => {
            if (line.startsWith('#EXTINF')) {
                const title = line.split(',')[1] || '频道';
                const logo = (line.match(/tvg-logo="([^"]+)"/) || [])[1];
                const group = (line.match(/group-title="([^"]+)"/) || [])[1] || '其它';
                const url = arr[i+1]?.trim();
                if (url?.startsWith('http')) app.data.push({title, logo, group, url});
            }
        });
        renderLobby();
    }

    function renderLobby() {
        const grid = document.getElementById('lobby-grid');
        const search = document.getElementById('search').value.toLowerCase();
        grid.innerHTML = '';
        app.data.filter(d => d.title.toLowerCase().includes(search)).forEach(d => {
            const el = document.createElement('div');
            el.className = 'card';
            el.onclick = () => openPlayer(d);
            el.innerHTML = `<img class="card-img" src="${d.logo || ''}" onerror="this.src='https://via.placeholder.com/160x90/222/555?text=TV'"><div class="card-name">${d.title}</div>`;
            grid.appendChild(el);
        });
    }

    document.getElementById('search').oninput = renderLobby;

    // 播放逻辑
    const v = document.getElementById('video');
    const hls = new Hls({ xhrSetup: (xhr) => xhr.withCredentials = false });

    function openPlayer(d) {
        app.currentCh = d;
        document.body.classList.add('player-active');
        document.getElementById('ch-title').innerText = d.title;
        document.getElementById('ch-logo').src = d.logo || '';
        
        if (Hls.isSupported()) {
            hls.loadSource(d.url); hls.attachMedia(v);
            hls.on(Hls.Events.MANIFEST_PARSED, () => v.play());
        } else { v.src = d.url; v.play(); }

        v.onloadedmetadata = () => {
            const isLive = v.duration === Infinity || v.duration > 86400;
            document.getElementById('live-tag').style.display = isLive ? 'flex' : 'none';
        };

        renderPlaylist(d.group);
        switchTopic(d.title);
    }

    function renderPlaylist(group) {
        const list = document.getElementById('playlist');
        list.innerHTML = '';
        app.data.filter(d => d.group === group).forEach(d => {
            const el = document.createElement('div');
            el.className = `play-item ${d === app.currentCh ? 'active' : ''}`;
            el.onclick = () => openPlayer(d);
            el.innerHTML = `<span>${d.title}</span><i class="fas fa-play-circle"></i>`;
            list.appendChild(el);
        });
    }

    function closePlayer() { document.body.classList.remove('player-active'); v.pause(); }
    function toggleFS() { if(!document.fullscreenElement) v.requestFullscreen(); else document.exitFullscreen(); }

    // 弹幕系统
    const canvas = document.getElementById('dm-canvas');
    const ctx = canvas.getContext('2d');
    let dms = [];

    function initMQTT() {
        app.mqtt = mqtt.connect(CONFIG.mqttBroker);
        app.mqtt.on('message', (t, m) => fireDm(m.toString(), false));
    }

    function switchTopic(title) {
        const newTopic = 'osb/ch/' + btoa(encodeURIComponent(title)).replace(/=/g,'');
        if (app.topic) app.mqtt.unsubscribe(app.topic);
        app.topic = newTopic; app.mqtt.subscribe(newTopic);
        dms = [];
    }

    function sendDm() {
        const inp = document.getElementById('dm-input');
        if (!inp.value.trim()) return;
        app.mqtt.publish(app.topic, inp.value);
        fireDm(inp.value, true); inp.value = '';
    }

    function initCanvas() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight * 0.35;
        ctx.font = "bold 20px Arial";
        const loop = () => {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            dms.forEach((d,i) => {
                d.x -= d.speed;
                ctx.fillStyle = d.color; ctx.strokeStyle = '#000'; ctx.lineWidth = 2;
                ctx.strokeText(d.text, d.x, d.y); ctx.fillText(d.text, d.x, d.y);
                if(d.x < -500) dms.splice(i,1);
            });
            requestAnimationFrame(loop);
        };
        loop();
    }

    function fireDm(text, self) {
        dms.push({ text, x: canvas.width, y: 30+Math.random()*(canvas.height-60), speed: 2+Math.random(), color: self?'#00ff88':'#fff' });
    }

    // 彩蛋逻辑
    function initLogo() {
        const logo = document.getElementById('logo-trigger');
        let timer;
        const start = () => { logo.classList.add('triggering'); timer = setTimeout(switchMode, 10000); };
        const end = () => { clearTimeout(timer); logo.classList.remove('triggering'); };
        ['mousedown','touchstart'].forEach(e => logo.addEventListener(e, start));
        ['mouseup','touchend'].forEach(e => logo.addEventListener(e, end));
    }

    function switchMode() {
        app.mode = app.mode === 'SAFE' ? 'ROOT' : 'SAFE';
        document.body.classList.toggle('root-mode', app.mode === 'ROOT');
        showToast(app.mode === 'ROOT' ? "隐私模式已解锁" : "安全模式");
        loadData(app.mode === 'ROOT' ? CONFIG.rootUrl : CONFIG.safeUrl);
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }
</script>
</body>
</html>
