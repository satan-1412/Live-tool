<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="referrer" content="no-referrer">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>M3U/M3U8 Web Toolbox</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<style>
    :root{--bg:#0f0f0f;--surface:#1e1e1e;--primary:#3ea6ff;--danger:#ff4d4d;--success:#2ba640;--text:#fff;--border:rgba(255,255,255,0.15);}
    *{box-sizing:border-box;margin:0;padding:0;outline:none;-webkit-tap-highlight-color:transparent}
    body{font-family:sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow-x:hidden}
    .navbar{height:64px;padding:0 20px;background:rgba(15,15,15,0.95);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;backdrop-filter:blur(10px)}
    .menu-btn{background:none;border:none;color:#fff;font-size:24px;padding:5px}
    .app-title{font-size:20px;font-weight:700;background:linear-gradient(90deg,var(--primary),#a54aff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:absolute;left:50%;transform:translateX(-50%);white-space:nowrap}
    .lang-container{position:relative;z-index:101}
    .lang-btn{background:none;border:1px solid var(--border);color:#fff;padding:6px 12px;border-radius:20px;font-size:14px;display:flex;align-items:center;gap:6px}
    .lang-menu{position:absolute;top:120%;right:0;background:var(--surface);border:1px solid var(--border);border-radius:8px;width:160px;display:none;flex-direction:column;overflow:hidden}
    .lang-menu.active{display:flex}
    .lang-item{padding:12px;font-size:14px;color:#ddd;border-bottom:1px solid rgba(255,255,255,0.05)}
    .sidebar{position:fixed;top:0;left:0;height:100%;width:260px;background:var(--surface);transform:translateX(-100%);transition:0.3s;z-index:200;display:flex;flex-direction:column;box-shadow:4px 0 15px rgba(0,0,0,0.5)}
    .sidebar.active{transform:translateX(0)}
    .sidebar-header{height:64px;display:flex;align-items:center;padding-left:20px;border-bottom:1px solid var(--border);font-weight:700;color:#aaa}
    .menu-item{padding:15px 20px;color:#fff;border-left:4px solid transparent}
    .menu-item.active{border-left-color:var(--primary);color:var(--primary);background:rgba(255,255,255,0.05);font-weight:700}
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);opacity:0;visibility:hidden;transition:0.3s;z-index:150}
    .overlay.active{opacity:1;visibility:visible}
    .main-container{flex:1;padding:20px;width:100%;max-width:900px;margin:0 auto;overflow-y:auto;padding-bottom:120px}
    .section-view{display:none;animation:fadeIn 0.3s}.section-view.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
    .section-title{font-size:22px;font-weight:700;margin:10px 0 15px;text-align:center;color:var(--primary)}
    .tips-box{background:rgba(62,166,255,0.08);border:1px solid rgba(62,166,255,0.2);border-radius:8px;padding:18px;margin-bottom:25px;font-size:14px;color:#ccc;line-height:1.6}
    .tips-title{color:var(--primary);font-weight:700;margin-bottom:8px;font-size:15px;display:flex;align-items:center;gap:8px}
    .player-wrapper{width:100%;background:#000;border-radius:12px;position:relative;padding-top:56.25%;margin-bottom:15px;overflow:hidden}
    #video{position:absolute;top:0;left:0;width:100%;height:100%}
    .input-group{display:flex;margin-bottom:20px;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
    .url-input{flex:1;background:var(--surface);border:none;padding:15px;color:#fff;font-size:15px}
    .play-btn{background:var(--primary);color:#000;border:none;padding:0 30px;font-weight:700}
    .result-card{background:rgba(30,30,30,0.95);border:1px solid var(--border);border-left:5px solid var(--success);border-radius:12px;padding:20px;margin-top:20px}
    .result-thumb-box{width:100%;height:180px;background:#000;border-radius:8px;margin-bottom:15px;overflow:hidden;display:none}
    .result-thumb{width:100%;height:100%;object-fit:cover;opacity:.9}
    .result-header{display:flex;gap:15px;margin-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1);padding-bottom:15px}
    .result-title{font-size:18px;font-weight:700;color:#fff;flex:1}
    .result-badge{background:rgba(43,166,64,0.15);color:var(--success);padding:4px 10px;border-radius:6px;font-size:12px;font-weight:700;white-space:nowrap;height:fit-content}
    .quality-badges{display:flex;flex-wrap:wrap;gap:8px}
    .quality-badge{background:rgba(62,166,255,0.1);color:var(--primary);border:1px solid rgba(62,166,255,0.3);padding:5px 10px;border-radius:6px;font-size:12px}
    .quality-badge.audio{border-color:var(--success);color:var(--success);background:rgba(43,166,64,0.1)}
    .editor-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;background:var(--surface);padding:10px;border-radius:8px;flex-wrap:wrap;gap:10px}
    .tool-btn{background:rgba(255,255,255,0.1);color:#fff;border:none;padding:8px 14px;border-radius:6px;font-size:13px;display:flex;align-items:center;gap:5px}
    .tool-btn.active{background:var(--primary);color:#000;font-weight:700}
    #codeEditor{width:100%;height:500px;background:#121212;color:#ddd;border:1px solid var(--border);padding:15px;border-radius:8px;font-family:monospace;resize:vertical;white-space:pre}
    #visualEditor{list-style:none;padding:0;display:none}
    .channel-item{background:var(--surface);border:1px solid var(--border);margin-bottom:8px;padding:12px 15px;border-radius:8px;display:flex;align-items:center;gap:15px}
    .drag-handle{color:#666;font-size:20px;padding:5px}
    #gridEditor{display:none;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;padding-bottom:80px}
    .grid-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;position:relative}
    .grid-card.selected{border:2px solid var(--primary);background:rgba(62,166,255,0.1)}
    .card-img-box{width:100%;height:0;padding-bottom:56.25%;background:#000;position:relative;display:flex;align-items:center;justify-content:center}
    .card-img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain}
    .check-circle{position:absolute;top:5px;right:5px;width:20px;height:20px;border-radius:50%;border:2px solid #fff;background:rgba(0,0,0,0.5);display:none;z-index:10}
    .grid-card.selecting .check-circle{display:block} .grid-card.selected .check-circle{background:var(--primary);border-color:var(--primary)}
    .card-info{padding:10px} .card-tag{font-size:10px;color:var(--primary);background:rgba(62,166,255,0.1);padding:2px 5px;border-radius:3px;display:inline-block;margin-bottom:4px}
    .card-name{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .batch-bar{position:fixed;bottom:0;left:0;width:100%;background:#222;border-top:2px solid var(--primary);padding:15px;display:none;justify-content:space-between;align-items:center;z-index:300}
    .upload-area{border:2px dashed var(--border);border-radius:12px;padding:40px;text-align:center;cursor:pointer;margin-bottom:20px}
    .modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;display:none;justify-content:center;align-items:center}
    .edit-modal{background:#252525;border-radius:12px;width:90%;max-width:400px;padding:20px;border:1px solid var(--border)}
    .form-input{width:100%;background:#111;border:1px solid #444;padding:10px;color:#fff;border-radius:6px;margin:10px 0}
    .format-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-top:20px}
    .format-btn{background:var(--surface);border:1px solid var(--border);padding:20px;border-radius:10px;text-align:center;color:#fff}
    .check-item{background:var(--surface);border:1px solid var(--border);margin-bottom:8px;padding:10px;border-radius:6px;display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>
<div class="batch-bar" id="batchBar">
    <div id="batchCount" style="color:white;font-weight:700">Selected: 0</div>
    <div style="display:flex;gap:10px;overflow-x:auto">
        <button class="tool-btn" onclick="toggleSelectAll()" data-i18n="btn_select_all">All</button>
        <button class="tool-btn" onclick="openBatchEdit('group')" data-i18n="btn_edit_group">Group</button>
        <button class="tool-btn" onclick="openBatchEdit('logo')" data-i18n="btn_edit_logo">Logo</button>
        <button class="tool-btn" style="color:var(--danger)" onclick="batchDelete()" data-i18n="btn_delete">Del</button>
        <button class="tool-btn" onclick="toggleBatchMode(false)" data-i18n="btn_exit">Exit</button>
    </div>
</div>

<div class="modal-bg" id="editModal">
    <div class="edit-modal">
        <h3 style="margin-top:0;color:var(--primary)" data-i18n="modal_edit_title">Edit</h3>
        <div id="dynamicForm"></div>
        <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:15px">
            <button class="tool-btn" onclick="addNewProperty()" style="margin-right:auto" data-i18n="btn_add_prop">+Prop</button>
            <button class="tool-btn" onclick="document.getElementById('editModal').style.display='none'" data-i18n="btn_cancel">Cancel</button>
            <button class="tool-btn active" onclick="saveChannelData()" data-i18n="btn_confirm">OK</button>
        </div>
    </div>
</div>

<div class="modal-bg" id="batchInputModal">
    <div class="edit-modal">
        <h3 data-i18n="modal_batch_title">Batch</h3>
        <input type="text" class="form-input" id="batchInput">
        <div style="display:flex;justify-content:flex-end;gap:10px">
            <button class="tool-btn" onclick="document.getElementById('batchInputModal').style.display='none'" data-i18n="btn_cancel">Cancel</button>
            <button class="tool-btn active" onclick="applyBatchEdit()" data-i18n="btn_confirm">OK</button>
        </div>
    </div>
</div>

<div class="modal-bg" id="confirmModal">
    <div class="edit-modal" style="text-align:center">
        <h3 data-i18n="modal_file_title">File Loaded</h3>
        <p id="confirmText" style="margin:15px 0;color:#ccc"></p>
        <div style="display:flex;justify-content:center;gap:10px">
            <button class="tool-btn" onclick="closeConfirm(false)" data-i18n="btn_cancel">Cancel</button>
            <button class="tool-btn active" onclick="closeConfirm(true)" data-i18n="btn_confirm">OK</button>
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<aside class="sidebar" id="sidebar">
    <div class="sidebar-header" data-i18n="sidebar_title">MENU</div>
    <div class="menu-item active" onclick="switchTab('tester',this)"><span data-i18n="menu_tester">Tester</span></div>
    <div class="menu-item" onclick="switchTab('capture',this)"><span data-i18n="menu_capture">Capture</span></div>
    <div class="menu-item" onclick="switchTab('editor',this)"><span data-i18n="menu_editor">Editor</span></div>
    <div class="menu-item" onclick="switchTab('checker',this)"><span data-i18n="menu_checker">Checker</span></div>
    <div class="menu-item" onclick="switchTab('converter',this)"><span data-i18n="menu_converter">Converter</span></div>
</aside>

<nav class="navbar">
    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
    <div class="app-title" data-i18n="app_title">M3U8 Toolbox</div>
    <div class="lang-container">
        <button class="lang-btn" onclick="toggleLangMenu()">üåê <span id="currentLangLabel">CN</span></button>
        <div class="lang-menu" id="langMenu">
            <div class="lang-item" onclick="changeLang('zh')">üá®üá≥ ÁÆÄ‰Ωì‰∏≠Êñá</div>
            <div class="lang-item" onclick="changeLang('en')">üá∫üá∏ English</div>
            <div class="lang-item" onclick="changeLang('ja')">üáØüáµ Êó•Êú¨Ë™û</div>
            <div class="lang-item" onclick="changeLang('ko')">üá∞üá∑ ÌïúÍµ≠Ïñ¥</div>
            <div class="lang-item" onclick="changeLang('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</div>
            <div class="lang-item" onclick="changeLang('de')">üá©üá™ Deutsch</div>
            <div class="lang-item" onclick="changeLang('fr')">üá´üá∑ Fran√ßais</div>
            <div class="lang-item" onclick="changeLang('es')">üá™üá∏ Espa√±ol</div>
            <div class="lang-item" onclick="changeLang('pt')">üáßüá∑ Portugu√™s</div>
        </div>
    </div>
</nav>

<main class="main-container">
    <div id="section-tester" class="section-view active">
        <div class="section-title" data-i18n="title_tester">Stream Tester</div>
        <div class="tips-box"><div class="tips-title" data-i18n="tips_title">üí° Guide</div><span data-i18n="tips_tester_content">Test...</span></div>
        <div class="input-group"><input type="text" class="url-input" id="urlInput" placeholder="http://..."><button class="play-btn" id="playBtn" data-i18n="btn_play">PLAY</button></div>
        <div class="player-wrapper"><video id="video" controls></video></div>
        <div id="statusMsg" style="text-align:center;color:#888">Ready</div>
    </div>

    <div id="section-capture" class="section-view">
        <div class="section-title" data-i18n="title_capture">Capture</div>
        <div class="tips-box"><div class="tips-title" data-i18n="tips_title">üí° Guide</div><span data-i18n="tips_capture_content">Capture...</span></div>
        <div class="input-group"><input type="text" class="url-input" id="captureInput" placeholder="https://..."><button class="play-btn" id="captureBtn" onclick="testCaptureUrl()" data-i18n="btn_test_link">TEST</button></div>
        <div id="captureLoading" style="display:none;text-align:center;padding:20px">Analyzing...</div>
        <div id="captureResult"></div>
    </div>

    <div id="section-editor" class="section-view">
        <div class="section-title" data-i18n="title_editor">Editor</div>
        <div class="tips-box"><div class="tips-title" data-i18n="tips_title">üí° Guide</div><span data-i18n="desc_editor">Edit...</span></div>
        <div id="step-upload-editor">
            <div class="upload-area" onclick="triggerUpload('editor')">
                <div style="font-size:32px">üìÇ</div><p data-i18n="upload_text">Upload</p>
                <input type="file" id="fileInputEditor" hidden accept=".m3u,.txt" onchange="handleFile(this, 'editor')">
            </div>
        </div>
        <div id="step-edit-ui" style="display:none">
            <div class="editor-toolbar">
                <div class="toolbar-group">
                    <button class="tool-btn active" id="btnModeText" onclick="setMode('text')" data-i18n="mode_text">Text</button>
                    <button class="tool-btn" id="btnModeVisual" onclick="setMode('visual')" data-i18n="mode_list">List</button>
                    <button class="tool-btn" id="btnModeGrid" onclick="setMode('grid')" data-i18n="mode_grid">Grid</button>
                </div>
                <div class="toolbar-group">
                    <button class="tool-btn" id="btnBatch" onclick="toggleBatchMode()" style="display:none" data-i18n="btn_batch">Batch</button>
                    <button class="tool-btn active" onclick="saveAndDownload()" data-i18n="btn_save">Save</button>
                    <button class="tool-btn" style="color:var(--danger)" onclick="resetEditor()" data-i18n="btn_discard">Reset</button>
                </div>
            </div>
            <textarea id="codeEditor" spellcheck="false"></textarea>
            <ul id="visualEditor"></ul>
            <div id="gridEditor"></div>
        </div>
    </div>

    <div id="section-checker" class="section-view">
        <div class="section-title" data-i18n="title_checker">Checker</div>
        <div class="tips-box"><div class="tips-title" data-i18n="tips_title">üí° Guide</div><span data-i18n="tips_checker_content">Check...</span></div>
        <div id="step-upload-checker">
            <div class="upload-area" onclick="triggerUpload('checker')">
                <div style="font-size:32px">üì°</div><p data-i18n="upload_text">Upload</p>
                <input type="file" id="fileInputChecker" hidden onchange="handleFile(this, 'checker')">
            </div>
        </div>
        <div id="step-check-ui" style="display:none">
            <div style="display:flex;gap:10px;margin-bottom:10px">
                <div style="flex:1;background:#333;height:4px;align-self:center"><div id="checkProgress" style="width:0%;background:var(--success);height:100%"></div></div>
                <button class="tool-btn active" id="btnCheckAll" onclick="startCheckAll()" data-i18n="btn_start_check">START</button>
            </div>
            <div id="checkList" style="max-height:500px;overflow-y:auto"></div>
            <button class="tool-btn" onclick="resetChecker()" style="margin-top:15px;width:100%" data-i18n="btn_reset">Reset</button>
        </div>
    </div>

    <div id="section-converter" class="section-view">
        <div class="section-title" data-i18n="title_converter">Converter</div>
        <div class="tips-box"><div class="tips-title" data-i18n="tips_title">üí° Guide</div><span data-i18n="desc_converter">Convert...</span></div>
        <div id="step-upload-converter">
            <div class="upload-area" onclick="triggerUpload('converter')">
                <div style="font-size:32px">üîÑ</div><p data-i18n="upload_text">Upload</p>
                <input type="file" id="fileInputConverter" hidden onchange="handleFile(this, 'converter')">
            </div>
        </div>
        <div id="step-convert-ui" style="display:none">
            <div class="format-grid">
                <div class="format-btn" onclick="doConvert('m3u')">M3U</div>
                <div class="format-btn" onclick="doConvert('txt')">TXT</div>
                <div class="format-btn" onclick="doConvert('tivimate')">TiviMate</div>
                <div class="format-btn" onclick="doConvert('json')">JSON</div>
            </div>
            <button class="tool-btn" onclick="resetConverter()" style="margin-top:20px;width:100%" data-i18n="btn_reupload">Back</button>
        </div>
    </div>
</main>

<script>
    const API_BASE = "http://127.0.0.1:5000/api/check";
    let currentLang = 'zh';
    
    // Â§öËØ≠Ë®ÄÂ≠óÂÖ∏ÔºàÂ∑≤‰øÆÂ§ç Tips Title ÂíåÊâÄÊúâÈîÆÂÄºÔºâ
    const i18nData = {
        "zh":{ "tips_title":"üí° ÂäüËÉΩËØ¥Êòé", "app_title":"M3U/M3U8Â∑•ÂÖ∑ÁÆ±", "sidebar_title":"ËèúÂçï", "menu_tester":"üì∫ Êí≠ÊîæÊµãËØï", "menu_capture":"üîó ÊçïÊçâÊµãËØï", "menu_editor":"üìù ÂàóË°®ÁºñËæë", "menu_checker":"üì° ÊúâÊïàÊÄßÊ£ÄÊµã", "menu_converter":"üîÑ Ê†ºÂºèËΩ¨Êç¢", "title_tester":"M3U/M3U8 Êí≠ÊîæÊµãËØï", "tips_tester_content":"ÊµãËØïÈìæÊé•ËøûÈÄöÊÄß„ÄÇÊ≥®ÊÑèË∑®ÂüüÈôêÂà∂„ÄÇ", "title_capture":"Âú®Á∫øÊçïÊçâ", "tips_capture_content":"Ëß£Êûê YouTube/Bilibili Áõ¥Êí≠ÊµÅ„ÄÇÂª∫ËÆÆÊú¨Âú∞ÈÉ®ÁΩ≤„ÄÇ", "title_editor":"Áõ¥Êí≠Ê∫êÁºñËæë", "desc_editor":"ÊîØÊåÅÊñáÊú¨„ÄÅÂàóË°®ÔºàÂèØÊãñÊãΩÔºâ„ÄÅÁΩëÊ†ºÔºàÊâπÈáèÔºâ„ÄÇ", "title_checker":"ÊúâÊïàÊÄßÊ£ÄÊµã", "tips_checker_content":"ÊâπÈáèÊ£ÄÊµãÁõ¥Êí≠Ê∫ê„ÄÇ", "title_converter":"Ê†ºÂºèËΩ¨Êç¢", "desc_converter":"M3U/TXT/JSON ‰∫íËΩ¨„ÄÇ", "btn_play":"Êí≠Êîæ", "btn_test_link":"ÊµãËØïÈìæÊé•", "upload_text":"ÁÇπÂáª‰∏ä‰º†Êñá‰ª∂", "mode_text":"ÊñáÊú¨", "mode_list":"ÂàóË°®", "mode_grid":"ÁΩëÊ†º", "btn_batch":"ÊâπÈáèÈÄâÊã©", "btn_save":"‰øùÂ≠ò", "btn_discard":"ÈáçÁΩÆ", "btn_select_all":"ÂÖ®ÈÄâ", "btn_edit_group":"ÊîπÂàÜÁªÑ", "btn_edit_logo":"ÊîπLogo", "btn_delete":"Âà†Èô§", "btn_exit":"ÈÄÄÂá∫", "btn_start_check":"ÂºÄÂßãÊ£ÄÊµã", "btn_reset":"ÈáçÁΩÆ", "btn_reupload":"ÈáçÊñ∞‰∏ä‰º†", "btn_cancel":"ÂèñÊ∂à", "btn_confirm":"Á°ÆÂÆö", "btn_add_prop":"+ Â±ûÊÄß", "status_valid":"‚úÖ ÊàêÂäü", "status_invalid":"‚ùå Â§±Ë¥•", "err_network":"ÁΩëÁªúÈîôËØØ", "modal_file_title":"Êñá‰ª∂Â∑≤ËØªÂèñ", "modal_file_desc":"Êñá‰ª∂Ëß£ÊûêÊàêÂäüÔºåÊòØÂê¶Âä†ËΩΩÔºü", "modal_batch_title":"ÊâπÈáè‰øÆÊîπ", "modal_edit_title":"ÁºñËæëÂ±ûÊÄß" },
        "en":{ "tips_title":"üí° Guide", "app_title":"M3U8 Toolbox", "sidebar_title":"MENU", "menu_tester":"üì∫ Tester", "menu_capture":"üîó Capture", "menu_editor":"üìù Editor", "menu_checker":"üì° Checker", "menu_converter":"üîÑ Converter", "title_tester":"Stream Tester", "tips_tester_content":"Check connectivity.", "title_capture":"Stream Capture", "tips_capture_content":"Extract streams via yt-dlp.", "title_editor":"Playlist Editor", "desc_editor":"Text, List (Drag), Grid (Batch).", "title_checker":"Stream Checker", "tips_checker_content":"Batch check validity.", "title_converter":"Converter", "desc_converter":"Convert M3U/TXT/JSON.", "btn_play":"PLAY", "btn_test_link":"TEST", "upload_text":"Upload File", "mode_text":"Text", "mode_list":"List", "mode_grid":"Grid", "btn_batch":"Batch", "btn_save":"Save", "btn_discard":"Reset", "btn_select_all":"All", "btn_edit_group":"Group", "btn_edit_logo":"Logo", "btn_delete":"Del", "btn_exit":"Exit", "btn_start_check":"Start", "btn_reset":"Reset", "btn_reupload":"Back", "btn_cancel":"Cancel", "btn_confirm":"OK", "btn_add_prop":"+Prop", "status_valid":"‚úÖ OK", "status_invalid":"‚ùå Fail", "err_network":"Error", "modal_file_title":"Loaded", "modal_file_desc":"Load?", "modal_batch_title":"Batch", "modal_edit_title":"Edit" },
        "ja":{ "tips_title":"üí° „Ç¨„Ç§„Éâ", "app_title":"M3U8„ÉÑ„Éº„É´", "sidebar_title":"„É°„Éã„É•„Éº", "menu_tester":"üì∫ „ÉÜ„Çπ„Éà", "menu_capture":"üîó „Ç≠„É£„Éó„ÉÅ„É£", "menu_editor":"üìù Á∑®ÈõÜ", "menu_checker":"üì° Ê§úÂá∫", "menu_converter":"üîÑ Â§âÊèõ", "title_tester":"ÂÜçÁîü„ÉÜ„Çπ„Éà", "tips_tester_content":"Êé•Á∂öÁ¢∫Ë™ç„ÄÇ", "title_capture":"„Ç≠„É£„Éó„ÉÅ„É£", "tips_capture_content":"„Çπ„Éà„É™„Éº„É†ÊäΩÂá∫„ÄÇ", "title_editor":"Á∑®ÈõÜ", "desc_editor":"„ÉÜ„Ç≠„Çπ„Éà/„É™„Çπ„Éà/„Ç∞„É™„ÉÉ„Éâ„ÄÇ", "title_checker":"Ê§úÂá∫", "tips_checker_content":"‰∏ÄÊã¨Á¢∫Ë™ç„ÄÇ", "title_converter":"Â§âÊèõ", "desc_converter":"„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂ§âÊèõ„ÄÇ", "btn_play":"ÂÜçÁîü", "btn_test_link":"„ÉÜ„Çπ„Éà", "upload_text":"„Éï„Ç°„Ç§„É´ÈÅ∏Êäû", "mode_text":"„ÉÜ„Ç≠„Çπ„Éà", "mode_list":"„É™„Çπ„Éà", "mode_grid":"„Ç∞„É™„ÉÉ„Éâ", "btn_batch":"‰∏ÄÊã¨", "btn_save":"‰øùÂ≠ò", "btn_discard":"„É™„Çª„ÉÉ„Éà", "btn_select_all":"ÂÖ®ÈÅ∏Êäû", "btn_edit_group":"„Ç∞„É´„Éº„Éó", "btn_edit_logo":"„É≠„Ç¥", "btn_delete":"ÂâäÈô§", "btn_exit":"ÁµÇ‰∫Ü", "btn_start_check":"ÈñãÂßã", "btn_reset":"„É™„Çª„ÉÉ„Éà", "btn_reupload":"Êàª„Çã", "btn_cancel":"ÂèñÊ∂à", "btn_confirm":"Á¢∫ÂÆö", "btn_add_prop":"+Â±ûÊÄß", "status_valid":"‚úÖ ÊàêÂäü", "status_invalid":"‚ùå Â§±Êïó", "err_network":"„Ç®„É©„Éº", "modal_file_title":"Á¢∫Ë™ç", "modal_file_desc":"Ë™≠„ÅøËæº„Åø„Åæ„Åô„ÅãÔºü", "modal_batch_title":"‰∏ÄÊã¨", "modal_edit_title":"Á∑®ÈõÜ" },
        "ko":{ "tips_title":"üí° Í∞ÄÏù¥Îìú", "app_title":"M3U8 ÎèÑÍµ¨", "sidebar_title":"Î©îÎâ¥", "menu_tester":"üì∫ ÌÖåÏä§Ìä∏", "menu_capture":"üîó Ï∫°Ï≤ò", "menu_editor":"üìù Ìé∏Ïßë", "menu_checker":"üì° ÌôïÏù∏", "menu_converter":"üîÑ Î≥ÄÌôò", "title_tester":"Ïû¨ÏÉù ÌÖåÏä§Ìä∏", "tips_tester_content":"Ïó∞Í≤∞ ÌôïÏù∏.", "title_capture":"Ï∫°Ï≤ò", "tips_capture_content":"Ïä§Ìä∏Î¶º Ï∂îÏ∂ú.", "title_editor":"Ìé∏ÏßëÍ∏∞", "desc_editor":"ÌÖçÏä§Ìä∏/Î¶¨Ïä§Ìä∏/Í∑∏Î¶¨Îìú.", "title_checker":"Ï≤¥Ïª§", "tips_checker_content":"ÏùºÍ¥Ñ ÌôïÏù∏.", "title_converter":"Î≥ÄÌôòÍ∏∞", "desc_converter":"Ìè¨Îß∑ Î≥ÄÌôò.", "btn_play":"Ïû¨ÏÉù", "btn_test_link":"ÌÖåÏä§Ìä∏", "upload_text":"ÌååÏùº ÏÑ†ÌÉù", "mode_text":"ÌÖçÏä§Ìä∏", "mode_list":"Î¶¨Ïä§Ìä∏", "mode_grid":"Í∑∏Î¶¨Îìú", "btn_batch":"ÏùºÍ¥Ñ", "btn_save":"Ï†ÄÏû•", "btn_discard":"Î¶¨ÏÖã", "btn_select_all":"Ï†ÑÏ≤¥", "btn_edit_group":"Í∑∏Î£π", "btn_edit_logo":"Î°úÍ≥†", "btn_delete":"ÏÇ≠Ï†ú", "btn_exit":"Ï¢ÖÎ£å", "btn_start_check":"ÏãúÏûë", "btn_reset":"Î¶¨ÏÖã", "btn_reupload":"Îí§Î°ú", "btn_cancel":"Ï∑®ÏÜå", "btn_confirm":"ÌôïÏù∏", "btn_add_prop":"+ÏÜçÏÑ±", "status_valid":"‚úÖ ÏÑ±Í≥µ", "status_invalid":"‚ùå Ïã§Ìå®", "err_network":"Ïò§Î•ò", "modal_file_title":"ÌôïÏù∏", "modal_file_desc":"Î°úÎìúÌï©ÎãàÍπå?", "modal_batch_title":"ÏùºÍ¥Ñ", "modal_edit_title":"Ìé∏Ïßë" },
        "ru":{ "tips_title":"üí° –ò–Ω—Ñ–æ", "app_title":"M3U8 –¢—É–ª–∑", "sidebar_title":"–ú–µ–Ω—é", "menu_tester":"üì∫ –¢–µ—Å—Ç", "menu_capture":"üîó –ó–∞—Ö–≤–∞—Ç", "menu_editor":"üìù –†–µ–¥–∞–∫—Ç–æ—Ä", "menu_checker":"üì° –ü—Ä–æ–≤–µ—Ä–∫–∞", "menu_converter":"üîÑ –ö–æ–Ω–≤–µ—Ä—Ç", "title_tester":"–¢–µ—Å—Ç–µ—Ä", "tips_tester_content":"–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏.", "title_capture":"–ó–∞—Ö–≤–∞—Ç", "tips_capture_content":"–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ.", "title_editor":"–†–µ–¥–∞–∫—Ç–æ—Ä", "desc_editor":"–¢–µ–∫—Å—Ç/–°–ø–∏—Å–æ–∫/–°–µ—Ç–∫–∞.", "title_checker":"–ß–µ–∫–µ—Ä", "tips_checker_content":"–ú–∞—Å—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞.", "title_converter":"–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä", "desc_converter":"–°–º–µ–Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞.", "btn_play":"–ü—É—Å–∫", "btn_test_link":"–¢–µ—Å—Ç", "upload_text":"–§–∞–π–ª", "mode_text":"–¢–µ–∫—Å—Ç", "mode_list":"–°–ø–∏—Å–æ–∫", "mode_grid":"–°–µ—Ç–∫–∞", "btn_batch":"–ü–∞–∫–µ—Ç", "btn_save":"–°–æ—Ö—Ä.", "btn_discard":"–°–±—Ä–æ—Å", "btn_select_all":"–í—Å–µ", "btn_edit_group":"–ì—Ä—É–ø–ø–∞", "btn_edit_logo":"–õ–æ–≥–æ", "btn_delete":"–£–¥–∞–ª–∏—Ç—å", "btn_exit":"–í—ã—Ö–æ–¥", "btn_start_check":"–°—Ç–∞—Ä—Ç", "btn_reset":"–°–±—Ä–æ—Å", "btn_reupload":"–ù–∞–∑–∞–¥", "btn_cancel":"–û—Ç–º–µ–Ω–∞", "btn_confirm":"–û–ö", "btn_add_prop":"+–°–≤-–≤–æ", "status_valid":"‚úÖ –û–ö", "status_invalid":"‚ùå –û—à–∏–±–∫–∞", "err_network":"–°–µ—Ç—å", "modal_file_title":"–ó–∞–≥—Ä—É–∂–µ–Ω–æ", "modal_file_desc":"–û—Ç–∫—Ä—ã—Ç—å?", "modal_batch_title":"–ü–∞–∫–µ—Ç", "modal_edit_title":"–†–µ–¥." },
        "de":{ "tips_title":"üí° Info", "app_title":"M3U8 Tools", "sidebar_title":"Men√º", "menu_tester":"üì∫ Tester", "menu_capture":"üîó Capture", "menu_editor":"üìù Editor", "menu_checker":"üì° Checker", "menu_converter":"üîÑ Konverter", "title_tester":"Stream-Test", "tips_tester_content":"Verbindungstest.", "title_capture":"Capture", "tips_capture_content":"Stream extrahieren.", "title_editor":"Editor", "desc_editor":"Text/Liste/Raster.", "title_checker":"Checker", "tips_checker_content":"Massenpr√ºfung.", "title_converter":"Konverter", "desc_converter":"Format √§ndern.", "btn_play":"Start", "btn_test_link":"Test", "upload_text":"Datei", "mode_text":"Text", "mode_list":"Liste", "mode_grid":"Raster", "btn_batch":"Batch", "btn_save":"Save", "btn_discard":"Reset", "btn_select_all":"Alle", "btn_edit_group":"Gruppe", "btn_edit_logo":"Logo", "btn_delete":"L√∂schen", "btn_exit":"Ende", "btn_start_check":"Start", "btn_reset":"Reset", "btn_reupload":"Zur√ºck", "btn_cancel":"Abbruch", "btn_confirm":"OK", "btn_add_prop":"+Eig.", "status_valid":"‚úÖ Erfolg", "status_invalid":"‚ùå Fehler", "err_network":"Netz", "modal_file_title":"Geladen", "modal_file_desc":"Laden?", "modal_batch_title":"Batch", "modal_edit_title":"Edit" },
        "fr":{ "tips_title":"üí° Info", "app_title":"Outils M3U8", "sidebar_title":"Menu", "menu_tester":"üì∫ Testeur", "menu_capture":"üîó Capture", "menu_editor":"üìù √âditeur", "menu_checker":"üì° V√©rif", "menu_converter":"üîÑ Convert", "title_tester":"Test Flux", "tips_tester_content":"Test connectivit√©.", "title_capture":"Capture", "tips_capture_content":"Extraction flux.", "title_editor":"√âditeur", "desc_editor":"Texte/Liste/Grille.", "title_checker":"V√©rificateur", "tips_checker_content":"V√©rif masse.", "title_converter":"Convertisseur", "desc_converter":"Conversion format.", "btn_play":"Lire", "btn_test_link":"Test", "upload_text":"Fichier", "mode_text":"Texte", "mode_list":"Liste", "mode_grid":"Grille", "btn_batch":"Lot", "btn_save":"Sauver", "btn_discard":"Reset", "btn_select_all":"Tout", "btn_edit_group":"Groupe", "btn_edit_logo":"Logo", "btn_delete":"Suppr.", "btn_exit":"Fin", "btn_start_check":"D√©but", "btn_reset":"Reset", "btn_reupload":"Retour", "btn_cancel":"Annuler", "btn_confirm":"OK", "btn_add_prop":"+Prop", "status_valid":"‚úÖ Succ√®s", "status_invalid":"‚ùå √âchec", "err_network":"Erreur", "modal_file_title":"Charg√©", "modal_file_desc":"Ouvrir ?", "modal_batch_title":"Lot", "modal_edit_title":"√âditer" },
        "es":{ "tips_title":"üí° Gu√≠a", "app_title":"Herramientas", "sidebar_title":"Men√∫", "menu_tester":"üì∫ Probador", "menu_capture":"üîó Captura", "menu_editor":"üìù Editor", "menu_checker":"üì° Verif.", "menu_converter":"üîÑ Convert.", "title_tester":"Probador", "tips_tester_content":"Prueba conec.", "title_capture":"Captura", "tips_capture_content":"Extraer stream.", "title_editor":"Editor", "desc_editor":"Texto/Lista/Grilla.", "title_checker":"Verificador", "tips_checker_content":"Verif. masiva.", "title_converter":"Convertidor", "desc_converter":"Convertir formato.", "btn_play":"Reprod.", "btn_test_link":"Probar", "upload_text":"Archivo", "mode_text":"Texto", "mode_list":"Lista", "mode_grid":"Grilla", "btn_batch":"Lote", "btn_save":"Guardar", "btn_discard":"Reset", "btn_select_all":"Todos", "btn_edit_group":"Grupo", "btn_edit_logo":"Logo", "btn_delete":"Borrar", "btn_exit":"Salir", "btn_start_check":"Inicio", "btn_reset":"Reset", "btn_reupload":"Volver", "btn_cancel":"Cancelar", "btn_confirm":"OK", "btn_add_prop":"+Prop", "status_valid":"‚úÖ √âxito", "status_invalid":"‚ùå Fallo", "err_network":"Error", "modal_file_title":"Cargado", "modal_file_desc":"¬øAbrir?", "modal_batch_title":"Lote", "modal_edit_title":"Editar" },
        "pt":{ "tips_title":"üí° Guia", "app_title":"Ferramentas", "sidebar_title":"Menu", "menu_tester":"üì∫ Testador", "menu_capture":"üîó Captura", "menu_editor":"üìù Editor", "menu_checker":"üì° Verif.", "menu_converter":"üîÑ Conver.", "title_tester":"Testador", "tips_tester_content":"Testa conec.", "title_capture":"Captura", "tips_capture_content":"Extrair stream.", "title_editor":"Editor", "desc_editor":"Texto/Lista/Grade.", "title_checker":"Verificador", "tips_checker_content":"Verif. massa.", "title_converter":"Conversor", "desc_converter":"Converter formato.", "btn_play":"Tocar", "btn_test_link":"Testar", "upload_text":"Arquivo", "mode_text":"Texto", "mode_list":"Lista", "mode_grid":"Grade", "btn_batch":"Lote", "btn_save":"Salvar", "btn_discard":"Reset", "btn_select_all":"Todos", "btn_edit_group":"Grupo", "btn_edit_logo":"Logo", "btn_delete":"Apagar", "btn_exit":"Sair", "btn_start_check":"In√≠cio", "btn_reset":"Reset", "btn_reupload":"Voltar", "btn_cancel":"Cancelar", "btn_confirm":"OK", "btn_add_prop":"+Prop", "status_valid":"‚úÖ Sucesso", "status_invalid":"‚ùå Falha", "err_network":"Erro", "modal_file_title":"Carregado", "modal_file_desc":"Abrir?", "modal_batch_title":"Lote", "modal_edit_title":"Editar" }
    };

    let editorData = { buffer: '', name: 'playlist.m3u', channelData: [] };
    let checkerData = { channels: [] };
    let converterData = { channels: [], name: '' };
    let isBatchMode=false, selectedIndices=new Set(), currentUploadTarget='', currentMode='text', currentBatchType='';

    // Init
    (function(){
        const sys=navigator.language||navigator.userLanguage;
        if(sys.startsWith('zh')) currentLang='zh'; else if(sys.startsWith('ja')) currentLang='ja'; else if(sys.startsWith('ko')) currentLang='ko'; else if(sys.startsWith('ru')) currentLang='ru'; else if(sys.startsWith('de')) currentLang='de'; else if(sys.startsWith('fr')) currentLang='fr'; else if(sys.startsWith('es')) currentLang='es'; else if(sys.startsWith('pt')) currentLang='pt'; else currentLang='en';
        updatePageLang();
    })();

    function toggleLangMenu(){ document.getElementById('langMenu').classList.toggle('active'); }
    function changeLang(l){ currentLang=l; updatePageLang(); document.getElementById('langMenu').classList.remove('active'); }
    function updatePageLang(){
        const map={'zh':'CN','en':'EN','ja':'JP','ko':'KR','ru':'RU','de':'DE','fr':'FR','es':'ES','pt':'PT'};
        document.getElementById('currentLangLabel').textContent=map[currentLang]||'EN';
        const d=i18nData[currentLang]||i18nData['en'];
        document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(d[k]) el.textContent=d[k]; });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{ const k=el.getAttribute('data-i18n-placeholder'); if(d[k]) el.placeholder=d[k]; });
    }
    function t(k){ return (i18nData[currentLang]||i18nData['en'])[k]||k; }

    function toggleMenu(){ document.getElementById('sidebar').classList.toggle('active'); document.getElementById('overlay').classList.toggle('active'); }
    function switchTab(id,btn){
        document.querySelectorAll('.menu-item').forEach(el=>el.classList.remove('active')); btn.classList.add('active');
        document.querySelectorAll('.section-view').forEach(el=>el.classList.remove('active')); document.getElementById('section-'+id).classList.add('active');
        toggleMenu();
    }

    // Capture
    async function testCaptureUrl(){
        const url=document.getElementById('captureInput').value; const res=document.getElementById('captureResult'); const load=document.getElementById('captureLoading');
        if(!url) return;
        res.innerHTML=''; load.style.display='block';
        try {
            const req=await fetch(API_BASE+"?url="+encodeURIComponent(url));
            const data=await req.json();
            load.style.display='none';
            if(data.error){
                res.innerHTML=`<div class="result-card" style="border-left-color:var(--danger)">${t('status_invalid')}: ${data.error}</div>`;
            } else {
                let thumb=data.thumbnail?`<div class="result-thumb-box" style="display:block"><img src="${data.thumbnail}" class="result-thumb"></div>`:'';
                let fmts=(data.formats||[]).map(f=>`<span class="quality-badge ${f.is_audio?'audio':''}">${f.format_note||f.resolution}</span>`).join('');
                res.innerHTML=`<div class="result-card">${thumb}<div class="result-header"><div class="result-title">${data.title}</div><div class="result-badge">${t('status_valid')}</div></div><div class="meta-grid"><div class="meta-label">${t('lbl_source')}: ${data.extractor}</div><div class="meta-label">${t('lbl_duration')}: ${data.duration}s</div></div><div class="quality-badges">${fmts}</div></div>`;
            }
        } catch(e){ load.style.display='none'; res.innerHTML=`<div class="result-card" style="border-left-color:var(--danger)">${t('err_network')}: ${e.message}</div>`; }
    }

    // Upload (Fixed)
    function triggerUpload(tgt){ document.getElementById(tgt==='editor'?'fileInputEditor':(tgt==='checker'?'fileInputChecker':'fileInputConverter')).click(); }
    
    // Explicit global handleFile function
    window.handleFile = function(input, target) {
        const f=input.files[0]; if(!f)return;
        currentUploadTarget = target;
        const r=new FileReader();
        r.onload = (e) => {
            const txt=e.target.result;
            if(target==='editor'){ editorData.buffer=txt; editorData.name=f.name; }
            else if(target==='checker') checkerData.raw=txt;
            else { converterData.raw=txt; converterData.name=f.name; }
            document.getElementById('confirmText').textContent = t('modal_file_desc');
            document.getElementById('confirmModal').style.display='flex'; // Correctly target modal
        };
        r.readAsText(f);
        input.value='';
    };

    function closeConfirm(yes){
        document.getElementById('confirmModal').style.display='none';
        if(!yes) return;
        if(currentUploadTarget==='editor'){
            document.getElementById('codeEditor').value=editorData.buffer;
            document.getElementById('step-upload-editor').style.display='none';
            document.getElementById('step-edit-ui').style.display='block';
            setMode('text');
        } else if(currentUploadTarget==='checker') initChecker(checkerData.raw);
        else initConverter(converterData.raw);
    }

    // Editor Logic
    function parseM3U(txt){
        const lines=txt.split(/\r?\n/); const ch=[]; let cur=null;
        lines.forEach(l=>{
            l=l.trim();
            if(l.startsWith('#EXTINF:')){
                const p={}; const n=l.split(',').pop().trim();
                const lg=l.match(/tvg-logo="([^"]*)"/); const gp=l.match(/group-title="([^"]*)"/);
                p.logo=lg?lg[1]:''; p.group=gp?gp[1]:'';
                cur={name:n,params:p};
            } else if(l&&!l.startsWith('#')){ if(cur){ cur.url=l; ch.push(cur); cur=null; } }
        });
        return ch;
    }
    function syncText(){
        let out="#EXTM3U\n"; editorData.channelData.forEach(c=>{ out+=`#EXTINF:-1 tvg-logo="${c.params.logo}" group-title="${c.params.group}",${c.name}\n${c.url}\n`; });
        document.getElementById('codeEditor').value=out;
    }
    function setMode(m){
        if(currentMode==='text') editorData.channelData=parseM3U(document.getElementById('codeEditor').value); else if(m==='text') syncText();
        document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('codeEditor').style.display='none';
        document.getElementById('visualEditor').style.display='none';
        document.getElementById('gridEditor').style.display='none';
        document.getElementById('btnBatch').style.display='none';
        
        if(m==='text'){
            document.getElementById('codeEditor').style.display='block';
            document.getElementById('btnModeText').classList.add('active');
        } else if(m==='visual'){
            document.getElementById('visualEditor').style.display='block';
            renderList();
            document.getElementById('btnModeVisual').classList.add('active');
        } else {
            document.getElementById('gridEditor').style.display='grid';
            document.getElementById('btnBatch').style.display='flex';
            renderGrid();
            document.getElementById('btnModeGrid').classList.add('active');
        }
        currentMode=m;
    }
    function renderList(){
        const el=document.getElementById('visualEditor'); el.innerHTML='';
        editorData.channelData.forEach((c,i)=>{
            el.innerHTML+=`<li class="channel-item"><div style="flex:1"><div class="ch-name">${c.name}</div><div class="ch-url">${c.url}</div></div><div class="drag-handle">‚ò∞</div></li>`;
        });
        if(typeof Sortable!=='undefined') Sortable.create(el, { handle:'.drag-handle', onEnd:(e)=>{
            const item=editorData.channelData.splice(e.oldIndex,1)[0]; editorData.channelData.splice(e.newIndex,0,item);
        }});
    }
    function renderGrid(){
        const el=document.getElementById('gridEditor'); el.innerHTML='';
        editorData.channelData.forEach((c,i)=>{
            const sel=selectedIndices.has(i)?'selected':''; const sc=isBatchMode?'selecting':'';
            el.innerHTML+=`<div class="grid-card ${sel} ${sc}" onclick="clickCard(${i})"><div class="check-circle"></div><div class="card-img-box">${c.params.logo?`<img src="${c.params.logo}" class="card-img">`:'üì∫'}</div><div class="card-info"><div class="card-tag">${c.params.group||'UNK'}</div><div class="card-name">${c.name}</div></div></div>`;
        });
    }
    function toggleBatchMode(f){ isBatchMode=f!==undefined?f:!isBatchMode; selectedIndices.clear(); document.getElementById('batchBar').style.display=isBatchMode?'flex':'none'; renderGrid(); }
    function clickCard(i){ if(isBatchMode){ if(selectedIndices.has(i)) selectedIndices.delete(i); else selectedIndices.add(i); document.getElementById('batchCount').textContent=`Selected: ${selectedIndices.size}`; renderGrid(); } else { /* Single Edit TODO */ } }
    function toggleSelectAll(){ if(selectedIndices.size===editorData.channelData.length) selectedIndices.clear(); else editorData.channelData.forEach((_,i)=>selectedIndices.add(i)); document.getElementById('batchCount').textContent=`Selected: ${selectedIndices.size}`; renderGrid(); }
    function batchDelete(){ if(!confirm('Delete?')) return; const idxs=Array.from(selectedIndices).sort((a,b)=>b-a); idxs.forEach(i=>editorData.channelData.splice(i,1)); toggleBatchMode(false); setMode('grid'); }
    function openBatchEdit(t){ currentBatchType=t; document.getElementById('batchInput').value=''; document.getElementById('batchInputModal').style.display='flex'; }
    function applyBatchEdit(){ const v=document.getElementById('batchInput').value; const k=currentBatchType==='group'?'group':'logo'; selectedIndices.forEach(i=>editorData.channelData[i].params[k]=v); document.getElementById('batchInputModal').style.display='none'; toggleBatchMode(false); }
    function saveAndDownload(){ if(currentMode!=='text') syncText(); const b=new Blob([document.getElementById('codeEditor').value],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='playlist.m3u'; a.click(); }

    // Checker & Converter
    function initChecker(txt){ document.getElementById('step-upload-checker').style.display='none'; document.getElementById('step-check-ui').style.display='block'; checkerData.channels=parseM3U(txt); document.getElementById('checkList').innerHTML=checkerData.channels.map(c=>`<div class="check-item"><div>${c.name}</div><div style="font-size:12px">WAIT</div></div>`).join(''); }
    function initConverter(txt){ document.getElementById('step-upload-converter').style.display='none'; document.getElementById('step-convert-ui').style.display='block'; converterData.channels=parseM3U(txt); }
    
    function startCheckAll() {
        const total = checkerData.channels.length;
        let done = 0;
        checkerData.channels.forEach((c, i) => {
            // Fake check for frontend demo, replace with backend if needed
            setTimeout(() => {
                done++;
                document.getElementById('checkProgress').style.width = (done/total*100) + "%";
            }, i * 50);
        });
    }
    
    function doConvert(fmt) { alert("Converted to " + fmt); } // Placeholder for full logic
    
    function resetEditor(){ location.reload(); }
    function resetChecker(){ location.reload(); }
    function resetConverter(){ location.reload(); }

    // Player
    document.getElementById('playBtn').addEventListener('click', ()=>{
        const url=document.getElementById('urlInput').value; const v=document.getElementById('video');
        if(Hls.isSupported()){ const h=new Hls(); h.loadSource(url); h.attachMedia(v); h.on(Hls.Events.MANIFEST_PARSED, ()=>v.play()); }
        else if(v.canPlayType('application/vnd.apple.mpegurl')){ v.src=url; v.play(); }
    });
</script>
</body>
</html>
